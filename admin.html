<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prince Alex Store Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        .main-content {
            flex: 1;
            padding: 1.5rem;
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .table-container {
            overflow-x: auto;
            max-height: 70vh; /* Limits height for scrolling */
        }
        table {
            min-width: 100%;
        }
        .sidebar {
            width: 280px;
            background-color: #1a202c; /* Dark gray for a professional look */
        }
        .sidebar a {
            padding: 1rem 1.5rem;
            border-left: 4px solid transparent;
            color: #d1d5db; /* Light gray text */
            transition: all 0.2s ease-in-out;
        }
        .sidebar a:hover {
            background-color: #2d3748;
        }
        .sidebar a.active {
            background-color: #2d3748;
            border-left-color: #3b82f6; /* Blue-500 */
            color: #ffffff;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fff;
            padding: 2rem;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            position: relative;
        }

        /* Toast Alert Styling */
        #toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1001;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .toast {
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        .toast.success { background-color: #10B981; /* Green-500 */ }
        .toast.error { background-color: #EF4444; /* Red-500 */ }
        .toast.info { background-color: #3B82F6; /* Blue-500 */ }
        .toast.warning { background-color: #F59E0B; /* Yellow-500 */ }

        /* Hide the spinner from number inputs */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

    </style>
</head>
<body class="bg-gray-100 flex min-h-screen">

    <div id="adminLoginModal" class="modal fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-[1002]">
        <div class="bg-white p-6 rounded-xl shadow-lg w-96">
            <h2 class="text-2xl font-bold mb-4 text-center text-red-700">Admin Login</h2>
            <input id="adminCode" type="password" 
                placeholder="Scan Card or Enter PIN"
                class="w-full border rounded-lg px-3 py-2 mb-4 focus:ring-2 focus:ring-red-600">
            <button onclick="adminLogin()" 
                class="w-full bg-red-600 hover:bg-red-700 text-white px-4 py-3 rounded-lg font-semibold transition duration-200 shadow-md">Login</button>
            <p id="loginError" class="text-red-600 text-sm mt-2 hidden text-center">‚ùå Invalid code or insufficient permissions.</p>
        </div>
    </div>
    
    <div id="toast-container"></div>

    <div id="adminPanel" class="hidden flex w-full">
        <aside class="sidebar text-white flex-shrink-0 flex flex-col pt-8 pb-4">
            <div class="flex items-center justify-center p-6 border-b border-gray-700">
                <img src="https://placehold.co/40x40/fff/000?text=A" alt="Admin Icon" class="rounded-full mr-2">
                <span class="text-lg font-bold">Admin Panel</span>
            </div>
            <nav class="flex-1 mt-6 space-y-2">
                <a href="#" class="flex items-center space-x-3 active" data-section="dashboard">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a8 8 0 100 16 8 8 0 000-16zM6 10a4 4 0 118 0 4 4 0 01-8 0z" clip-rule="evenodd" /></svg>
                    <span>Dashboard</span>
                </a>
                <a href="#" class="flex items-center space-x-3" data-section="products">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 2a8 8 0 100 16 8 8 0 000-16zM6 10a4 4 0 118 0 4 4 0 01-8 0z" clip-rule="evenodd" /></svg>
                    <span>Products Management</span>
                </a>
                <a href="#" class="flex items-center space-x-3" data-section="users">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
                    <span>Users Management</span>
                </a>
                <a href="#" class="flex items-center space-x-3" data-section="sales">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.171 1.341l.244-.122a1.002 1.002 0 00.933-.42l4.98-9.96-2.5-1.25a1 1 0 00-.777 1.87L9 15l2.223-1.111a1 1 0 00.554-1.87l-2.5-1.25 4.98-9.96a1.002 1.002 0 00.933.42l.244.122a1 1 0 001.171-1.341l-7-14z" /></svg>
                    <span>Sales Reports</span>
                </a>
                <a href="#" class="flex items-center space-x-3" data-section="manager-logs">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-1 1v1h2V3a1 1 0 10-2 0zm-2 2h6l.5 1h-7l.5-1zM4 6a2 2 0 012-2h8a2 2 0 012 2v2H4V6zm14 3h-2v1h2v1h-2v1h2v-3zm-2-2h2v1h-2v-1zm-2 5a2 2 0 01-2 2H6a2 2 0 01-2-2V8h12v4z" clip-rule="evenodd" /></svg>
                    <span>Manager Approvals</span>
                </a>
                <a href="#" class="flex items-center space-x-3" data-section="audit-logs">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a8 8 0 100 16 8 8 0 000-16zM9 9a1 1 0 002 0v-2a1 1 0 10-2 0v2zm1 4a1 1 0 100 2 1 1 0 000-2z" /></svg>
                    <span>Audit Logs</span>
                </a>
            </nav>
            <div class="mt-auto p-4 border-t border-gray-700">
                <button onclick="adminLogout()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">Logout</button>
            </div>
        </aside>

        <main class="flex-1 p-6">
            <section id="dashboard" class="main-content">
                <h2 class="text-3xl font-bold mb-6 text-gray-800">Dashboard Overview</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-blue-100 p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold text-blue-800">Sales Today</h3>
                        <p id="salesToday" class="text-4xl font-bold text-blue-900 mt-2">KSh 0.00</p>
                    </div>
                    <div class="bg-green-100 p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold text-green-800">Active Cashiers</h3>
                        <p id="activeCashiers" class="text-4xl font-bold text-green-900 mt-2">0</p>
                    </div>
                    <div class="bg-yellow-100 p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold text-yellow-800">Low Stock Alerts</h3>
                        <p id="lowStockAlerts" class="text-4xl font-bold text-yellow-900 mt-2">0</p>
                    </div>
                </div>
            </section>

            <section id="products" class="main-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">Products Management</h2>
                    <button id="addProductBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">
                        + Add New Product
                    </button>
                </div>
                <div class="table-container bg-white rounded-lg shadow-md">
                    <table class="w-full">
                        <thead class="bg-blue-600 text-white sticky top-0">
                            <tr>
                                <th class="py-3 px-4 text-left text-sm font-medium rounded-tl-lg">Barcode</th>
                                <th class="py-3 px-4 text-left text-sm font-medium">Product Name</th>
                                <th class="py-3 px-4 text-left text-sm font-medium">Price (KSh)</th>
                                <th class="py-3 px-4 text-left text-sm font-medium">Stock</th>
                                <th class="py-3 px-4 text-left text-sm font-medium">VAT Rate</th>
                                <th class="py-3 px-4 text-left text-sm font-medium rounded-tr-lg">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="productsTableBody" class="divide-y divide-gray-200">
                            <tr>
                                <td colspan="6" class="py-4 text-center text-gray-500">Loading products...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="users" class="main-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">Users Management</h2>
                    <button id="addUserBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">
                        + Add New User
                    </button>
                </div>
                <div class="table-container bg-white rounded-lg shadow-md">
                    <table class="w-full">
                        <thead class="bg-blue-600 text-white sticky top-0">
                            <tr>
                                <th class="py-3 px-4 text-left text-sm font-medium rounded-tl-lg">Name</th>
                                <th class="py-3 px-4 text-left text-sm font-medium">Role</th>
                                <th class="py-3 px-4 text-left text-sm font-medium">Card ID</th>
                                <th class="py-3 px-4 text-left text-sm font-medium">PIN</th>
                                <th class="py-3 px-4 text-left text-sm font-medium rounded-tr-lg">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody" class="divide-y divide-gray-200">
                            <tr>
                                <td colspan="5" class="py-4 text-center text-gray-500">Loading users...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="sales" class="main-content hidden">
                <h2 class="text-3xl font-bold mb-6 text-gray-800">Sales Reports</h2>
                <div class="flex items-center space-x-4 mb-6">
                    <input type="date" id="saleStartDate" class="border rounded-lg p-2">
                    <input type="date" id="saleEndDate" class="border rounded-lg p-2">
                    <input type="text" id="saleSearchInput" placeholder="Search by cashier/product..." class="border rounded-lg p-2 flex-1">
                    <button id="filterSalesBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Filter</button>
                    <button id="exportSalesBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Export CSV</button>
                </div>
                <div class="table-container bg-white rounded-lg shadow-md">
                    <table class="w-full">
                        <thead class="bg-blue-600 text-white sticky top-0">
                            <tr>
                                <th class="py-3 px-4 text-left text-sm font-medium rounded-tl-lg">Invoice No.</th>
                                <th class="py-3 px-4 text-left text-sm font-medium">Date</th>
                                <th class="py-3 px-4 text-left text-sm font-medium">Cashier</th>
                                <th class="py-3 px-4 text-left text-sm font-medium">Grand Total</th>
                                <th class="py-3 px-4 text-left text-sm font-medium">Payment Method</th>
                                <th class="py-3 px-4 text-left text-sm font-medium rounded-tr-lg">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="salesTableBody" class="divide-y divide-gray-200">
                            <tr>
                                <td colspan="6" class="py-4 text-center text-gray-500">No sales data.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="manager-logs" class="main-content hidden">
                <h2 class="text-3xl font-bold mb-6 text-gray-800">Manager Approvals</h2>
                <div class="table-container bg-white rounded-lg shadow-md">
                    <table class="w-full">
                        <thead class="bg-blue-600 text-white sticky top-0">
                            <tr>
                                <th class="py-3 px-4 text-left text-sm font-medium rounded-tl-lg">Timestamp</th>
                                <th class="py-3 px-4 text-left text-sm font-medium">Manager</th>
                                <th class="py-3 px-4 text-left text-sm font-medium">Cashier</th>
                                <th class="py-3 px-4 text-left text-sm font-medium">Action</th>
                                <th class="py-3 px-4 text-left text-sm font-medium rounded-tr-lg">Item</th>
                            </tr>
                        </thead>
                        <tbody id="managerLogsTableBody" class="divide-y divide-gray-200">
                            <tr>
                                <td colspan="5" class="py-4 text-center text-gray-500">No approval logs.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
            
            <section id="audit-logs" class="main-content hidden">
                <h2 class="text-3xl font-bold mb-6 text-gray-800">Audit Logs</h2>
                <div class="table-container bg-white rounded-lg shadow-md">
                    <table class="w-full">
                        <thead class="bg-blue-600 text-white sticky top-0">
                            <tr>
                                <th class="py-3 px-4 text-left text-sm font-medium rounded-tl-lg">Timestamp</th>
                                <th class="py-3 px-4 text-left text-sm font-medium">User</th>
                                <th class="py-3 px-4 text-left text-sm font-medium">Action</th>
                                <th class="py-3 px-4 text-left text-sm font-medium">Details</th>
                                <th class="py-3 px-4 text-left text-sm font-medium rounded-tr-lg">Status</th>
                            </tr>
                        </thead>
                        <tbody id="auditLogsTableBody" class="divide-y divide-gray-200">
                            <tr>
                                <td colspan="5" class="py-4 text-center text-gray-500">No audit logs.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <div id="productModal" class="modal">
        <div class="modal-content">
            <h3 id="productModalTitle" class="text-2xl font-bold mb-4 text-gray-800">Add Product</h3>
            <form id="productForm">
                <input type="hidden" id="productId">
                <div class="mb-4">
                    <label for="productBarcode" class="block text-gray-700 text-sm font-bold mb-2">Barcode</label>
                    <input type="text" id="productBarcode" required class="w-full p-2 border rounded-lg focus:ring-blue-500">
                </div>
                <div class="mb-4">
                    <label for="productName" class="block text-gray-700 text-sm font-bold mb-2">Product Name</label>
                    <input type="text" id="productName" required class="w-full p-2 border rounded-lg focus:ring-blue-500">
                </div>
                <div class="mb-4">
                    <label for="productPrice" class="block text-gray-700 text-sm font-bold mb-2">Price (KSh)</label>
                    <input type="number" id="productPrice" step="0.01" required class="w-full p-2 border rounded-lg focus:ring-blue-500">
                </div>
                <div class="mb-4">
                    <label for="productStock" class="block text-gray-700 text-sm font-bold mb-2">Stock</label>
                    <input type="number" id="productStock" required class="w-full p-2 border rounded-lg focus:ring-blue-500">
                </div>
                <div class="mb-4">
                    <label for="productVatRate" class="block text-gray-700 text-sm font-bold mb-2">VAT Rate (e.g., 0.16 for 16%)</label>
                    <input type="number" id="productVatRate" step="0.01" required class="w-full p-2 border rounded-lg focus:ring-blue-500">
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" onclick="closeModal('productModal')" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Save Product</button>
                </div>
            </form>
        </div>
    </div>

    <div id="userModal" class="modal">
        <div class="modal-content">
            <h3 id="userModalTitle" class="text-2xl font-bold mb-4 text-gray-800">Add User</h3>
            <form id="userForm">
                <input type="hidden" id="userId">
                <div class="mb-4">
                    <label for="userName" class="block text-gray-700 text-sm font-bold mb-2">Full Name</label>
                    <input type="text" id="userName" required class="w-full p-2 border rounded-lg focus:ring-blue-500">
                </div>
                <div class="mb-4">
                    <label for="userRole" class="block text-gray-700 text-sm font-bold mb-2">Role</label>
                    <select id="userRole" required class="w-full p-2 border rounded-lg focus:ring-blue-500">
                        <option value="cashier">Cashier</option>
                        <option value="manager">Manager</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="userCardId" class="block text-gray-700 text-sm font-bold mb-2">Card ID (Optional)</label>
                    <input type="text" id="userCardId" class="w-full p-2 border rounded-lg focus:ring-blue-500">
                </div>
                <div class="mb-4">
                    <label for="userPin" class="block text-gray-700 text-sm font-bold mb-2">PIN</label>
                    <input type="password" id="userPin" required class="w-full p-2 border rounded-lg focus:ring-blue-500">
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" onclick="closeModal('userModal')" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Save User</button>
                </div>
            </form>
        </div>
    </div>
    
    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, getDocs, setDoc, addDoc, updateDoc, deleteDoc, doc, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Firebase config (from index.html)
        const firebaseConfig = {
            apiKey: "AIzaSyAUNs3WYS2mkvPvzRDfhyZFUbP2XpZjDQg",
            authDomain: "retailflow-pos-11726.firebaseapp.com",
            projectId: "retailflow-pos-11726",
            storageBucket: "retailflow-pos-11726.firebasestorage.app",
            messagingSenderId: "309314798354",
            appId: "1:309314798354:web:30784c2b2e7e42168629cb"
        };

        // Initialize Firebase + Firestore
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Firestore collection references
        const productsCol = collection(db, "products");
        const salesCol = collection(db, "sales");
        const usersCol = collection(db, "users");
        const managerLogsCol = collection(db, "managerLogs");
        const auditLogsCol = collection(db, "auditLogs"); // New Audit Logs collection

        // --- Global Variables ---
        let products = [];
        let users = [];
        let sales = [];
        let managerLogs = [];
        let auditLogs = [];
        let currentAdmin = null;

        // --- DOM Elements ---
        const adminLoginModal = document.getElementById('adminLoginModal');
        const adminCodeInput = document.getElementById('adminCode');
        const loginErrorMsg = document.getElementById('loginError');
        const adminPanel = document.getElementById('adminPanel');
        const sidebarLinks = document.querySelectorAll('.sidebar a');
        const sections = document.querySelectorAll('.main-content');
        const toastContainer = document.getElementById('toast-container');

        // Dashboard Elements
        const salesTodaySpan = document.getElementById('salesToday');
        const activeCashiersSpan = document.getElementById('activeCashiers');
        const lowStockAlertsSpan = document.getElementById('lowStockAlerts');

        // Products Management Elements
        const productsTableBody = document.getElementById('productsTableBody');
        const addProductBtn = document.getElementById('addProductBtn');
        const productModal = document.getElementById('productModal');
        const productModalTitle = document.getElementById('productModalTitle');
        const productForm = document.getElementById('productForm');
        const productIdInput = document.getElementById('productId');
        const productBarcodeInput = document.getElementById('productBarcode');
        const productNameInput = document.getElementById('productName');
        const productPriceInput = document.getElementById('productPrice');
        const productStockInput = document.getElementById('productStock');
        const productVatRateInput = document.getElementById('productVatRate');

        // Users Management Elements
        const usersTableBody = document.getElementById('usersTableBody');
        const addUserBtn = document.getElementById('addUserBtn');
        const userModal = document.getElementById('userModal');
        const userModalTitle = document.getElementById('userModalTitle');
        const userForm = document.getElementById('userForm');
        const userIdInput = document.getElementById('userId');
        const userNameInput = document.getElementById('userName');
        const userRoleInput = document.getElementById('userRole');
        const userCardIdInput = document.getElementById('userCardId');
        const userPinInput = document.getElementById('userPin');

        // Sales Reports Elements
        const salesTableBody = document.getElementById('salesTableBody');
        const saleStartDateInput = document.getElementById('saleStartDate');
        const saleEndDateInput = document.getElementById('saleEndDate');
        const saleSearchInput = document.getElementById('saleSearchInput');
        const filterSalesBtn = document.getElementById('filterSalesBtn');
        const exportSalesBtn = document.getElementById('exportSalesBtn');

        // Manager Logs Elements
        const managerLogsTableBody = document.getElementById('managerLogsTableBody');
        
        // Audit Logs Elements
        const auditLogsTableBody = document.getElementById('auditLogsTableBody');


        // --- Helper Functions ---
        
        function showToast(message, type = 'info', duration = 3000) {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            toastContainer.appendChild(toast);
            void toast.offsetWidth;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove(), { once: true });
            }, duration);
        }

        function showSection(sectionId) {
            sections.forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');
            sidebarLinks.forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`[data-section="${sectionId}"]`).classList.add('active');
        }

        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        function formatCurrency(amount) {
            return `KSh ${parseFloat(amount).toFixed(2)}`;
        }

        function formatDate(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString();
        }

        // --- Authentication ---

        async function adminLogin() {
            const code = adminCodeInput.value.trim();
            loginErrorMsg.classList.add("hidden");
            
            try {
                const q = query(usersCol, where("role", "==", "admin"));
                const snapshot = await getDocs(q);
                let found = null;
                snapshot.forEach(docSnap => {
                    const user = docSnap.data();
                    if (user.code === code || user.cardId === code) {
                        found = { id: docSnap.id, ...user };
                    }
                });

                if (found) {
                    currentAdmin = found;
                    localStorage.setItem("currentAdmin", JSON.stringify(found));
                    adminLoginModal.classList.add("hidden");
                    adminPanel.classList.remove("hidden");
                    showToast(`‚úÖ Welcome, ${currentAdmin.name}!`, "success");
                    initializeAdminPanel();
                } else {
                    loginErrorMsg.classList.remove("hidden");
                    showToast("‚ùå Invalid Admin PIN or Card ID.", "error");
                    adminCodeInput.value = '';
                    adminCodeInput.focus();
                }
            } catch (error) {
                console.error("Error during admin login:", error);
                showToast("Login failed. Please check console.", "error");
            }
        }
        
        function adminLogout() {
            currentAdmin = null;
            localStorage.removeItem("currentAdmin");
            showToast("Logged out successfully.", "info");
            adminPanel.classList.add("hidden");
            adminLoginModal.classList.remove("hidden");
            adminCodeInput.value = '';
            adminCodeInput.focus();
            
            // Stop all listeners on logout
            if (productsUnsubscribe) productsUnsubscribe();
            if (usersUnsubscribe) usersUnsubscribe();
            if (salesUnsubscribe) salesUnsubscribe();
            if (managerLogsUnsubscribe) managerLogsUnsubscribe();
            if (auditLogsUnsubscribe) auditLogsUnsubscribe();
        }
        
        // Unsubscribe functions for real-time listeners
        let productsUnsubscribe, usersUnsubscribe, salesUnsubscribe, managerLogsUnsubscribe, auditLogsUnsubscribe;

        // --- Data Fetching and Rendering ---

        function initializeAdminPanel() {
            // Setup real-time listeners for all collections
            productsUnsubscribe = onSnapshot(productsCol, (snapshot) => {
                products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderProducts();
                updateDashboard();
            });
            usersUnsubscribe = onSnapshot(usersCol, (snapshot) => {
                users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderUsers();
                updateDashboard();
            });
            salesUnsubscribe = onSnapshot(salesCol, (snapshot) => {
                sales = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderSales(sales); // Initial render
                updateDashboard();
            });
            managerLogsUnsubscribe = onSnapshot(managerLogsCol, (snapshot) => {
                managerLogs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderManagerLogs();
            });
            auditLogsUnsubscribe = onSnapshot(auditLogsCol, (snapshot) => {
                auditLogs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAuditLogs();
            });

            showSection('dashboard');
        }

        // --- Dashboard Functions ---
        async function updateDashboard() {
            // Sales Today
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const salesToday = sales.filter(s => new Date(s.timestamp) >= today);
            const totalSalesToday = salesToday.reduce((sum, s) => sum + s.grandTotal, 0);
            salesTodaySpan.textContent = formatCurrency(totalSalesToday);

            // Active Cashiers (placeholder, based on last login or a specific field)
            const activeCashierCount = users.filter(u => u.role === 'cashier').length;
            activeCashiersSpan.textContent = activeCashierCount;

            // Low Stock Alerts
            const lowStockCount = products.filter(p => p.stock < 10).length;
            lowStockAlertsSpan.textContent = lowStockCount;
        }

        // --- Products Management Functions ---
        function renderProducts() {
            productsTableBody.innerHTML = '';
            products.forEach(product => {
                const row = document.createElement('tr');
                row.className = 'bg-white hover:bg-gray-50';
                row.innerHTML = `
                    <td class="py-3 px-4 text-gray-800">${product.id}</td>
                    <td class="py-3 px-4 text-gray-800">${product.name}</td>
                    <td class="py-3 px-4 text-gray-700">${formatCurrency(product.price)}</td>
                    <td class="py-3 px-4 text-gray-700">${product.stock}</td>
                    <td class="py-3 px-4 text-gray-700">${(product.vatRate * 100).toFixed(0)}%</td>
                    <td class="py-3 px-4">
                        <button onclick="editProduct('${product.id}')" class="text-blue-600 hover:text-blue-800 mr-2">Edit</button>
                        <button onclick="deleteProduct('${product.id}')" class="text-red-600 hover:text-red-800">Delete</button>
                    </td>
                `;
                productsTableBody.appendChild(row);
            });
            if (products.length === 0) {
                productsTableBody.innerHTML = `<tr><td colspan="6" class="py-4 text-center text-gray-500">No products found.</td></tr>`;
            }
        }

        async function saveProduct() {
            const id = productIdInput.value.trim();
            const barcode = productBarcodeInput.value.trim();
            const name = productNameInput.value.trim();
            const price = parseFloat(productPriceInput.value);
            const stock = parseInt(productStockInput.value, 10);
            const vatRate = parseFloat(productVatRateInput.value);

            if (!barcode || !name || isNaN(price) || isNaN(stock) || isNaN(vatRate)) {
                showToast("Please fill all required fields correctly.", "error");
                return;
            }

            try {
                if (id) {
                    await updateDoc(doc(db, "products", id), {
                        barcode, name, price, stock, vatRate
                    });
                    showToast("Product updated successfully!", "success");
                    logAudit("Update Product", `Updated product: ${name} (ID: ${id})`);
                } else {
                    const newProductRef = doc(productsCol);
                    await setDoc(newProductRef, {
                        id: newProductRef.id, // Use the generated ID
                        barcode, name, price, stock, vatRate
                    });
                    showToast("Product added successfully!", "success");
                    logAudit("Add Product", `Added new product: ${name}`);
                }
                closeModal('productModal');
            } catch (e) {
                console.error("Error saving product:", e);
                showToast("Failed to save product. Check console for details.", "error");
            }
        }
        
        function editProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (product) {
                productModalTitle.textContent = "Edit Product";
                productIdInput.value = product.id;
                productBarcodeInput.value = product.barcode;
                productNameInput.value = product.name;
                productPriceInput.value = product.price;
                productStockInput.value = product.stock;
                productVatRateInput.value = product.vatRate;
                openModal('productModal');
            }
        }

        async function deleteProduct(productId) {
            if (confirm("Are you sure you want to delete this product?")) {
                try {
                    await deleteDoc(doc(db, "products", productId));
                    showToast("Product deleted successfully!", "success");
                    logAudit("Delete Product", `Deleted product with ID: ${productId}`);
                } catch (e) {
                    console.error("Error deleting product:", e);
                    showToast("Failed to delete product. Check console.", "error");
                }
            }
        }

        // --- Users Management Functions ---
        function renderUsers() {
            usersTableBody.innerHTML = '';
            users.forEach(user => {
                const row = document.createElement('tr');
                row.className = 'bg-white hover:bg-gray-50';
                row.innerHTML = `
                    <td class="py-3 px-4 text-gray-800">${user.name}</td>
                    <td class="py-3 px-4 text-gray-800">${user.role}</td>
                    <td class="py-3 px-4 text-gray-700">${user.cardId || 'N/A'}</td>
                    <td class="py-3 px-4 text-gray-700">${user.code || 'N/A'}</td>
                    <td class="py-3 px-4">
                        <button onclick="editUser('${user.id}')" class="text-blue-600 hover:text-blue-800 mr-2">Edit</button>
                        <button onclick="deleteUser('${user.id}')" class="text-red-600 hover:text-red-800">Delete</button>
                    </td>
                `;
                usersTableBody.appendChild(row);
            });
            if (users.length === 0) {
                usersTableBody.innerHTML = `<tr><td colspan="5" class="py-4 text-center text-gray-500">No users found.</td></tr>`;
            }
        }

        async function saveUser() {
            const id = userIdInput.value.trim();
            const name = userNameInput.value.trim();
            const role = userRoleInput.value;
            const cardId = userCardIdInput.value.trim() || null;
            const code = userPinInput.value.trim();

            if (!name || !role || !code) {
                showToast("Please fill all required fields correctly.", "error");
                return;
            }
            if (code.length !== 4) {
                 showToast("PIN must be exactly 4 digits.", "error");
                 return;
            }

            try {
                const userData = { name, role, cardId, code };
                if (id) {
                    await updateDoc(doc(db, "users", id), userData);
                    showToast("User updated successfully!", "success");
                    logAudit("Update User", `Updated user: ${name} (${role})`);
                } else {
                    const newUserRef = doc(usersCol);
                    await setDoc(newUserRef, { id: newUserRef.id, ...userData });
                    showToast("User added successfully!", "success");
                    logAudit("Add User", `Added new user: ${name} (${role})`);
                }
                closeModal('userModal');
            } catch (e) {
                console.error("Error saving user:", e);
                showToast("Failed to save user. Check console.", "error");
            }
        }
        
        function editUser(userId) {
            const user = users.find(u => u.id === userId);
            if (user) {
                userModalTitle.textContent = "Edit User";
                userIdInput.value = user.id;
                userNameInput.value = user.name;
                userRoleInput.value = user.role;
                userCardIdInput.value = user.cardId || '';
                userPinInput.value = user.code;
                openModal('userModal');
            }
        }

        async function deleteUser(userId) {
            if (confirm("Are you sure you want to delete this user?")) {
                try {
                    await deleteDoc(doc(db, "users", userId));
                    showToast("User deleted successfully!", "success");
                    logAudit("Delete User", `Deleted user with ID: ${userId}`);
                } catch (e) {
                    console.error("Error deleting user:", e);
                    showToast("Failed to delete user. Check console.", "error");
                }
            }
        }

        // --- Sales Reports Functions ---
        function renderSales(salesData) {
            salesTableBody.innerHTML = '';
            salesData.forEach(sale => {
                const row = document.createElement('tr');
                row.className = 'bg-white hover:bg-gray-50';
                row.innerHTML = `
                    <td class="py-3 px-4 text-gray-800">${sale.invoiceNo}</td>
                    <td class="py-3 px-4 text-gray-700">${formatDate(sale.timestamp)}</td>
                    <td class="py-3 px-4 text-gray-700">${sale.cashierName}</td>
                    <td class="py-3 px-4 text-gray-700">${formatCurrency(sale.grandTotal)}</td>
                    <td class="py-3 px-4 text-gray-700">${sale.paymentMethod}</td>
                    <td class="py-3 px-4">
                        <button onclick="showSaleDetails('${sale.id}')" class="text-blue-600 hover:text-blue-800">View Details</button>
                    </td>
                `;
                salesTableBody.appendChild(row);
            });
            if (salesData.length === 0) {
                salesTableBody.innerHTML = `<tr><td colspan="6" class="py-4 text-center text-gray-500">No sales data.</td></tr>`;
            }
        }

        function filterSales() {
            const startDate = saleStartDateInput.value ? new Date(saleStartDateInput.value).getTime() : 0;
            const endDate = saleEndDateInput.value ? new Date(saleEndDateInput.value).getTime() + 86399999 : Infinity; // End of day
            const searchTerm = saleSearchInput.value.toLowerCase();
            
            const filtered = sales.filter(sale => {
                const saleDate = new Date(sale.timestamp).getTime();
                const matchesDate = saleDate >= startDate && saleDate <= endDate;
                
                const matchesSearch = !searchTerm || 
                    sale.cashierName.toLowerCase().includes(searchTerm) ||
                    sale.cartItems.some(item => item.name.toLowerCase().includes(searchTerm));
                
                return matchesDate && matchesSearch;
            });
            
            renderSales(filtered);
            showToast(`Found ${filtered.length} sales.`, 'info');
        }

        function exportSalesToCSV() {
            const header = ["Invoice No.", "Date", "Time", "Cashier", "Grand Total", "Payment Method", "Items"];
            const rows = sales.map(sale => {
                const date = new Date(sale.timestamp);
                const itemsList = sale.cartItems.map(item => `${item.name} (x${item.quantity})`).join("; ");
                return [
                    sale.invoiceNo,
                    date.toLocaleDateString(),
                    date.toLocaleTimeString(),
                    sale.cashierName,
                    sale.grandTotal,
                    sale.paymentMethod,
                    `"${itemsList}"`
                ];
            });
            
            const csvContent = "data:text/csv;charset=utf-8," + [header.join(","), ...rows.map(e => e.join(","))].join("\n");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `sales_report_${new Date().toISOString().slice(0, 10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast("Sales data exported to CSV!", "success");
        }

        // --- Manager Approvals Functions ---
        function renderManagerLogs() {
            managerLogsTableBody.innerHTML = '';
            managerLogs.sort((a, b) => b.timestamp.seconds - a.timestamp.seconds); // Sort by most recent
            managerLogs.forEach(log => {
                const row = document.createElement('tr');
                row.className = 'bg-white hover:bg-gray-50';
                row.innerHTML = `
                    <td class="py-3 px-4 text-gray-800">${log.timestamp ? new Date(log.timestamp.seconds * 1000).toLocaleString() : 'N/A'}</td>
                    <td class="py-3 px-4 text-gray-700">${log.manager}</td>
                    <td class="py-3 px-4 text-gray-700">${log.cashier}</td>
                    <td class="py-3 px-4 text-gray-700">${log.action}</td>
                    <td class="py-3 px-4 text-gray-700">${log.item}</td>
                `;
                managerLogsTableBody.appendChild(row);
            });
            if (managerLogs.length === 0) {
                managerLogsTableBody.innerHTML = `<tr><td colspan="5" class="py-4 text-center text-gray-500">No manager approval logs.</td></tr>`;
            }
        }

        // --- Audit Logs Functions ---
        async function logAudit(action, details) {
            try {
                await addDoc(auditLogsCol, {
                    user: currentAdmin ? currentAdmin.name : "Unknown",
                    action: action,
                    details: details,
                    timestamp: new Date().toISOString()
                });
            } catch (e) {
                console.error("Error logging audit action:", e);
            }
        }

        function renderAuditLogs() {
            auditLogsTableBody.innerHTML = '';
            auditLogs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            auditLogs.forEach(log => {
                const row = document.createElement('tr');
                row.className = 'bg-white hover:bg-gray-50';
                row.innerHTML = `
                    <td class="py-3 px-4 text-gray-800">${new Date(log.timestamp).toLocaleString()}</td>
                    <td class="py-3 px-4 text-gray-700">${log.user}</td>
                    <td class="py-3 px-4 text-gray-700">${log.action}</td>
                    <td class="py-3 px-4 text-gray-700">${log.details}</td>
                    <td class="py-3 px-4 text-gray-700">Success</td>
                `;
                auditLogsTableBody.appendChild(row);
            });
            if (auditLogs.length === 0) {
                auditLogsTableBody.innerHTML = `<tr><td colspan="5" class="py-4 text-center text-gray-500">No audit logs.</td></tr>`;
            }
        }


        // --- Event Listeners ---
        
        // Navigation links
        sidebarLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const sectionId = link.dataset.section;
                showSection(sectionId);
            });
        });
        
        // Modals
        window.onclick = function(event) {
            if (event.target === productModal) {
                closeModal('productModal');
            }
            if (event.target === userModal) {
                closeModal('userModal');
            }
        };

        // Product Modal
        addProductBtn.addEventListener('click', () => {
            productModalTitle.textContent = "Add New Product";
            productForm.reset();
            productIdInput.value = '';
            openModal('productModal');
        });
        productForm.addEventListener('submit', (e) => {
            e.preventDefault();
            saveProduct();
        });

        // User Modal
        addUserBtn.addEventListener('click', () => {
            userModalTitle.textContent = "Add New User";
            userForm.reset();
            userIdInput.value = '';
            openModal('userModal');
        });
        userForm.addEventListener('submit', (e) => {
            e.preventDefault();
            saveUser();
        });

        // Sales Reports
        filterSalesBtn.addEventListener('click', filterSales);
        exportSalesBtn.addEventListener('click', exportSalesToCSV);
        
        // Initial Load Logic
        document.addEventListener('DOMContentLoaded', () => {
            const storedAdmin = localStorage.getItem("currentAdmin");
            if (storedAdmin) {
                currentAdmin = JSON.parse(storedAdmin);
                adminLoginModal.classList.add("hidden");
                adminPanel.classList.remove("hidden");
                initializeAdminPanel();
            } else {
                adminCodeInput.focus();
                // Keep login input focused for USB barcode scanner entry
                adminCodeInput.addEventListener("blur", () => setTimeout(() => adminCodeInput.focus(), 100));
            }
        });

    </script>
</body>
</html>
