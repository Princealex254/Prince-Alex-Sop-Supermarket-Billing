<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prince Alex Store POS</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- html5-qrcode Library -->
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        .pos-container {
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            flex: 1; /* Allows it to take up remaining space */
        }
        .receipt-modal, .manager-approval-modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
        }
        .receipt-content, .manager-approval-content {
            background-color: #fff;
            margin: auto;
            padding: 1.5rem;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 320px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            position: relative;
            font-size: 0.75rem;
            line-height: 1.2;
        }
        .receipt-content hr {
            border-top: 1px dashed #cbd5e0;
            margin: 0.75rem 0;
        }
        .receipt-content table {
            font-size: 0.7rem;
        }

        /* Toast Alert Styling */
        #toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1001;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .toast {
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        .toast.success { background-color: #10B981; /* Green-500 */ }
        .toast.error { background-color: #EF4444; /* Red-500 */ }
        .toast.info { background-color: #3B82F6; /* Blue-500 */ }
        .toast.warning { background-color: #F59E0B; /* Yellow-500 */ }

        /* Scanner message styling */
        .scanner-message {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(255, 255, 255, 0.8);
            color: #4a5568;
            font-weight: 600;
            z-index: 10; /* Above the video feed */
            border-radius: 0.5rem;
        }


        @media print {
            body * {
                visibility: hidden;
            }
            .receipt-modal, .receipt-modal * {
                visibility: visible;
            }
            .receipt-modal {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: auto;
                background-color: #fff;
                box-shadow: none;
            }
            .receipt-content {
                width: 100%;
                max-width: none;
                margin: 0;
                padding: 0.5rem;
                box-shadow: none;
                border-radius: 0;
                font-size: 0.7rem;
            }
            .receipt-content hr {
                margin: 0.5rem 0;
            }
            .receipt-content table {
                font-size: 0.65rem;
            }
            .receipt-close-btn, #printReceiptFromModalBtn {
                display: none;
            }
            /* Hide toast container and manager approval modal when printing */
            #toast-container, .manager-approval-modal {
                display: none;
            }
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">
    <!-- Top Bar -->
    <header class="bg-blue-700 text-white p-4 flex items-center justify-between shadow-md">
        <h1 class="text-xl font-bold">Prince Alex Store POS</h1>
        <div class="flex items-center space-x-4">
            <span class="text-lg">Cashier: <span id="cashierNameDisplay" class="font-semibold">Prince Alex</span></span>
            <button id="adminPanelBtn" class="bg-blue-800 hover:bg-blue-900 text-white font-bold py-2 px-4 rounded-lg transition duration-200 shadow-sm">Admin Panel</button>
            <button id="logoutBtn" class="bg-blue-800 hover:bg-blue-900 text-white font-bold py-2 px-4 rounded-lg transition duration-200 shadow-sm">Logout</button>
        </div>
    </header>

    <!-- Main Billing Panel (now full width) -->
    <main class="flex-1 p-6 flex justify-center items-start">
        <div class="pos-container flex flex-col lg:flex-row p-6 w-full max-w-5xl"> <!-- Added max-w for better centering -->
            <!-- Left Section: Product Search & Cart -->
            <div class="lg:w-2/3 p-4 bg-white rounded-l-xl lg:border-r border-gray-200">
                <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center lg:text-left">Billing Panel</h1>

                <!-- Search Bar and Scanner Controls -->
                <div class="mb-6 flex flex-col sm:flex-row items-center gap-3">
                    <input type="text" id="productSearch" placeholder="Scan or type product barcode/name..."
                           class="w-full sm:w-2/3 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg shadow-sm">
                    <button onclick="startScanner()" class="w-full sm:w-1/3 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg transition duration-200 shadow-md">
                        üì∑ Scan Barcode
                    </button>
                </div>

                <!-- Where the video scanner will appear -->
                <div id="reader" style="width: 100%; margin-top: 10px; position: relative;">
                    <div id="productScannerMessage" class="scanner-message hidden">
                        Initializing camera...
                    </div>
                </div>
                <button onclick="stopScanner()" id="stopScannerBtn" class="hidden w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg mt-2 transition duration-200 shadow-md">
                    ‚ùå Close Scanner
                </button>

                <!-- Product Search Results (Hidden until search) -->
                <div id="searchResults" class="mb-6 hidden">
                    <h2 class="text-xl font-semibold text-gray-700 mb-3">Search Results</h2>
                    <div id="productResultsList" class="max-h-60 overflow-y-auto border border-gray-200 rounded-lg bg-gray-50">
                        <!-- Products will be dynamically inserted here -->
                    </div>
                </div>

                <!-- Cart Table -->
                <div class="mb-6">
                    <h2 class="text-xl font-semibold text-gray-700 mb-3">Current Cart</h2>
                    <div class="overflow-x-auto rounded-lg shadow-md">
                        <table class="min-w-full bg-white">
                            <thead class="bg-blue-600 text-white">
                                <tr>
                                    <th class="py-3 px-4 text-left text-sm font-medium rounded-tl-lg">Item Name</th>
                                    <th class="py-3 px-4 text-left text-sm font-medium">Qty</th>
                                    <th class="py-3 px-4 text-left text-sm font-medium">Price</th>
                                    <th class="py-3 px-4 text-left text-sm font-medium">VAT</th>
                                    <th class="py-3 px-4 text-left text-sm font-medium rounded-tr-lg">Subtotal</th>
                                </tr>
                            </thead>
                            <tbody id="cartItems" class="divide-y divide-gray-200">
                                <!-- Cart items will be dynamically inserted here -->
                                <tr id="emptyCartMessage">
                                    <td colspan="5" class="py-4 px-4 text-center text-gray-500">Cart is empty. Add items!</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Right Section: Cart Summary & Payment -->
            <div class="lg:w-1/3 p-4 bg-gray-50 rounded-r-xl lg:rounded-l-none mt-6 lg:mt-0">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Order Summary</h2>

                <!-- Cart Summary -->
                <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-lg font-medium text-gray-700">Total (Before VAT):</span>
                        <span id="totalBeforeVat" class="text-lg font-semibold text-gray-900">KSh 0.00</span>
                    </div>
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-lg font-medium text-gray-700">VAT Amount (16%):</span>
                        <span id="vatAmount" class="text-lg font-semibold text-gray-900">KSh 0.00</span>
                    </div>
                    <hr class="my-4 border-gray-200">
                    <div class="flex justify-between items-center">
                        <span class="text-xl font-bold text-gray-800">Grand Total:</span>
                        <span id="grandTotal" class="text-2xl font-extrabold text-blue-700">KSh 0.00</span>
                        </div>
                </div>

                <!-- Payment Section -->
                <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Payment Options</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
                        <button id="payCashBtn" class="payment-btn bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition duration-200 shadow-md" disabled>Cash</button>
                        <button id="payMpesaBtn" class="payment-btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 shadow-md" disabled>M-PESA</button>
                        <button id="payCardBtn" class="payment-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg transition duration-200 shadow-md" disabled>Card</button>
                    </div>

                    <div id="cashPaymentSection" class="hidden">
                        <label for="cashReceived" class="block text-gray-700 text-sm font-bold mb-2">Cash Received (KSh):</label>
                        <input type="number" id="cashReceived" placeholder="Enter amount"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg shadow-sm mb-4">
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-lg font-medium text-gray-700">Balance:</span>
                            <span id="balanceAmount" class="text-xl font-bold text-red-600">KSh 0.00</span>
                        </div>
                    </div>

                    <!-- M-Pesa/Card Payment Status Display -->
                    <div id="digitalPaymentStatus" class="hidden text-center p-3 mt-4 rounded-lg bg-gray-100">
                        <p id="digitalPaymentMessage" class="text-gray-700 font-semibold mb-2"></p>
                        <p id="digitalPaymentDetails" class="text-sm text-gray-600"></p>
                    </div>

                    <button id="completeSaleBtn" class="w-full bg-blue-700 hover:bg-blue-800 text-white font-bold py-4 px-4 rounded-lg text-xl transition duration-200 shadow-lg mt-4" disabled>Complete Sale</button>
                </div>

                <button id="printReceiptBtn" class="w-full bg-gray-700 hover:bg-gray-800 text-white font-bold py-3 px-4 rounded-lg text-lg transition duration-200 shadow-md">Print Receipt</button>
            </div>
        </div>
    </main>

    <!-- Receipt Modal -->
    <div id="receiptModal" class="receipt-modal">
        <div class="receipt-content">
            <button class="receipt-close-btn absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            <div id="receiptContentBody">
                <!-- Receipt details will be dynamically inserted here -->
            </div>
            <button id="printReceiptFromModalBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg mt-4">Print</button>
        </div>
    </div>

    <!-- Manager Approval Modal -->
    <div id="managerApprovalModal" class="manager-approval-modal">
        <div class="manager-approval-content text-center">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Manager Approval Required</h3>
            <p class="text-gray-700 mb-4">Scan Manager Card or Enter Code to approve item cancellation.</p>

            <!-- Manager Scanner UI -->
            <button onclick="startManagerScanner()" id="startManagerScannerBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 shadow-md mb-3">
                üì∑ Scan Manager Card
            </button>
            <div id="managerReader" style="width: 100%; margin-top: 10px; position: relative;">
                <div id="managerScannerMessage" class="scanner-message hidden">
                    Initializing camera...
                </div>
            </div>
            <button onclick="stopManagerScanner()" id="stopManagerScannerBtn" class="hidden w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg mt-2 transition duration-200 shadow-md mb-3">
                ‚ùå Close Scanner
            </button>

            <input type="text" id="managerCardIdInput" placeholder="Scan Manager Card ID"
                   class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg shadow-sm mb-3">
            <p class="text-gray-600 mb-3">- OR -</p>
            <input type="password" id="managerCodeInput" placeholder="Enter Manager Code"
                   class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg shadow-sm mb-4">
            <button id="approveManagerBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 shadow-md mb-2">Approve</button>
            <button id="cancelManagerBtn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg transition duration-200 shadow-md">Cancel</button>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <script type="module">
        //
        // üîë Firebase Security Rules (IMPORTANT!) üîë
        //
        // You are encountering "Missing or insufficient permissions" because your Firestore
        // database rules are not configured to allow the application to read and write data.
        //
        // To fix this, you need to go to your Firebase project console:
        // 1. Go to Firestore Database -> Rules tab.
        // 2. Replace the existing rules with the following for development purposes.
        //    (For production, you'll need more refined rules based on authentication.)
        //
        // rules_version = '2';
        // service cloud.firestore {
        //   match /databases/{database}/documents {
        //     // Allow read and write access to 'products', 'sales', 'users', and 'managerLogs'
        //     // for any authenticated user. For testing, you might even allow unauthenticated access
        //     // but ensure to tighten this for production!
        //     match /{document=**} {
        //       allow read, write: if true; // WARNING: This allows anyone to read/write!
        //                                   // Use this ONLY for initial setup/testing.
        //                                   // For production, consider: allow read, write: if request.auth != null;
        //     }
        //
        //     // More specific rules (example for authenticated users):
        //     // match /products/{productId} {
        //     //   allow read, write: if request.auth != null;
        //     // }
        //     // match /sales/{saleId} {
        //     //   allow read, write: if request.auth != null;
        //     // }
        //     // match /users/{userId} {
        //     //   allow read, write: if request.auth != null;
        //     // }
        //     // match /managerLogs/{logId} {
        //     //   allow read, write: if request.auth != null;
        //     // }
        //   }
        // }
        //
        // After updating the rules, publish them. Your application should then be able to
        // interact with Firestore correctly.
        //

        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, getDocs, getDoc, setDoc, addDoc, updateDoc, deleteDoc, doc, query, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Firebase config (yours)
        const firebaseConfig = {
            apiKey: "AIzaSyAUNs3WYS2mkvPvzRDfhyZFUbP2XpZjDQg",
            authDomain: "retailflow-pos-11726.firebaseapp.com",
            projectId: "retailflow-pos-11726",
            storageBucket: "retailflow-pos-11726.firebasestorage.app",
            messagingSenderId: "309314798354",
            appId: "1:309314798354:web:30784c2b2e7e42168629cb"
        };

        // Initialize Firebase + Firestore
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Firestore collection references
        const productsCol = collection(db, "products");
        const salesCol = collection(db, "sales");
        const usersCol = collection(db, "users"); // Users collection reference
        const managerLogsCol = collection(db, "managerLogs"); // New: Manager Logs collection reference

        // --- Product Database (Initial Data) ---
        // This will now be loaded from Firestore
        let products = []; 

        // --- Global Variables ---
        let cart = []; // Stores items currently in the cart
        let selectedPaymentMethod = null;
        let transactionIdCounter = 1000; // Simple counter for transaction IDs
        let pendingApprovalAction = null; // Stores the function to execute after manager approval
        let pendingApprovalActionDetails = { action: '', itemName: '' }; // Stores details for logging manager action
        let paymentConfirmed = false; // Tracks if a digital payment has been confirmed
        let html5QrcodeScanner; // Declare product scanner variable globally
        let html5QrcodeManagerScanner; // Declare manager scanner variable globally
        let isScanningProduct = false; // Flag to prevent multiple product scans simultaneously
        let isScanningManager = false; // Flag to prevent multiple manager scans simultaneously
        let lastScannedCode = null; // New: Debounce variable for product scanner

        // --- DOM Elements ---
        const productSearchInput = document.getElementById('productSearch');
        const searchResultsDiv = document.getElementById('searchResults');
        const productResultsList = document.getElementById('productResultsList');
        const cartItemsTableBody = document.getElementById('cartItems');
        const emptyCartMessage = document.getElementById('emptyCartMessage');
        const totalBeforeVatSpan = document.getElementById('totalBeforeVat');
        const vatAmountSpan = document.getElementById('vatAmount');
        const grandTotalSpan = document.getElementById('grandTotal');
        const payCashBtn = document.getElementById('payCashBtn');
        const payMpesaBtn = document.getElementById('payMpesaBtn');
        const payCardBtn = document.getElementById('payCardBtn');
        const cashPaymentSection = document.getElementById('cashPaymentSection');
        const cashReceivedInput = document.getElementById('cashReceived');
        const balanceAmountSpan = document.getElementById('balanceAmount');
        const completeSaleBtn = document.getElementById('completeSaleBtn');
        const printReceiptBtn = document.getElementById('printReceiptBtn');
        const receiptModal = document.getElementById('receiptModal');
        const receiptContentBody = document.getElementById('receiptContentBody');
        const receiptCloseBtn = document.querySelector('.receipt-close-btn');
        const printReceiptFromModalBtn = document.getElementById('printReceiptFromModalBtn');
        const toastContainer = document.getElementById('toast-container');
        const cashierNameDisplay = document.getElementById('cashierNameDisplay');
        const stopScannerBtn = document.getElementById('stopScannerBtn'); // Get the new stop scanner button
        const adminPanelBtn = document.getElementById('adminPanelBtn'); // Get the new Admin Panel button

        // Manager Approval Modal Elements
        const managerApprovalModal = document.getElementById('managerApprovalModal');
        const managerCardIdInput = document.getElementById('managerCardIdInput');
        const managerCodeInput = document.getElementById('managerCodeInput');
        const approveManagerBtn = document.getElementById('approveManagerBtn');
        const cancelManagerBtn = document.getElementById('cancelManagerBtn');
        const managerReaderDiv = document.getElementById('managerReader'); // New: Manager scanner reader div
        const startManagerScannerBtn = document.getElementById('startManagerScannerBtn'); // New: Start manager scanner button
        const stopManagerScannerBtn = document.getElementById('stopManagerScannerBtn'); // New: Stop manager scanner button

        // Scanner messages
        const productScannerMessage = document.getElementById('productScannerMessage');
        const managerScannerMessage = document.getElementById('managerScannerMessage');


        // Digital Payment Status Elements
        const digitalPaymentStatusDiv = document.getElementById('digitalPaymentStatus');
        const digitalPaymentMessage = document.getElementById('digitalPaymentMessage');
        const digitalPaymentDetails = document.getElementById('digitalPaymentDetails');


        // --- Helper Functions ---

        /**
         * Displays a toast notification.
         * @param {string} message - The message to display.
         * @param {'success'|'error'|'info'|'warning'} type - The type of toast (for styling).
         * @param {number} duration - How long the toast should be visible in ms.
         */
        function showToast(message, type = 'info', duration = 3000) {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            toastContainer.appendChild(toast);

            // Trigger reflow to ensure transition plays
            void toast.offsetWidth;

            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove(), { once: true });
            }, duration);
        }

        /**
         * Plays a simple beep sound.
         */
        function playBeep() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.type = 'sine'; // Sine wave for a clean beep
                oscillator.frequency.setValueAtTime(880, audioContext.currentTime); // A4 note
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime); // Volume

                oscillator.start(audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + 0.1); // Short decay
                oscillator.stop(audioContext.currentTime + 0.1); // Stop after 0.1 seconds
            } catch (e) {
                console.warn("AudioContext not supported or error playing sound:", e);
            }
        }

        /**
         * Formats a number to currency string (KSh).
         * @param {number} amount - The amount to format.
         * @returns {string} Formatted currency string.
         */
        function formatCurrency(amount) {
            return `KSh ${amount.toFixed(2)}`;
        }

        /**
         * Calculates VAT for a single item.
         * @param {object} product - The product object.
         * @param {number} quantity - The quantity of the product.
         * @returns {number} The calculated VAT amount.
         */
        function calculateItemVat(product, quantity) {
            return product.price * quantity * product.vatRate;
        }

        /**
         * Calculates the subtotal for a single item (price * quantity + item VAT).
         * @param {object} product - The product object.
         * @param {number} quantity - The quantity of the product.
         * @returns {number} The calculated item subtotal.
         */
        function calculateItemSubtotal(product, quantity) {
            return (product.price * quantity) + calculateItemVat(product, quantity);
        }

        /**
         * Updates the cart summary (total before VAT, VAT amount, grand total).
         * Also controls the complete sale button's disabled state.
         */
        function calculateTotals() {
            let totalBeforeVat = 0;
            let totalVatAmount = 0;

            cart.forEach(item => {
                totalBeforeVat += item.product.price * item.quantity;
                totalVatAmount += calculateItemVat(item.product, item.quantity);
            });

            const grandTotal = totalBeforeVat + totalVatAmount;

            totalBeforeVatSpan.textContent = formatCurrency(totalBeforeVat);
            vatAmountSpan.textContent = formatCurrency(totalVatAmount);
            grandTotalSpan.textContent = formatCurrency(grandTotal);

            // Logic for enabling/disabling complete sale button
            let enableCompleteSale = false;
            if (cart.length > 0) {
                if (selectedPaymentMethod === 'Cash') {
                    const cashReceived = parseFloat(cashReceivedInput.value) || 0;
                    enableCompleteSale = cashReceived >= grandTotal;
                } else if (selectedPaymentMethod === 'Mpesa' || selectedPaymentMethod === 'Card') {
                    enableCompleteSale = paymentConfirmed;
                }
            }
            completeSaleBtn.disabled = !enableCompleteSale;
            printReceiptBtn.disabled = cart.length === 0;

            // Disable payment buttons if cart is empty
            const paymentButtons = [payCashBtn, payMpesaBtn, payCardBtn];
            if (cart.length === 0) {
                paymentButtons.forEach(btn => btn.disabled = true);
                // Also reset selected payment method display if cart becomes empty
                selectedPaymentMethod = null;
                paymentConfirmed = false;
                cashPaymentSection.classList.add('hidden');
                digitalPaymentStatusDiv.classList.add('hidden');
                document.querySelectorAll('.payment-btn').forEach(btn => {
                    btn.classList.remove('ring-2', 'ring-offset-2', 'ring-blue-500');
                });
            } else {
                paymentButtons.forEach(btn => btn.disabled = false);
            }
        }

        /**
         * Renders products in the search results list.
         * @param {Array<object>} filteredProducts - Products to display.
         */
        function renderProducts(filteredProducts) {
            productResultsList.innerHTML = ''; // Clear previous results
            if (filteredProducts.length === 0) {
                productResultsList.innerHTML = '<p class="p-4 text-gray-500">No products found.</p>';
                return;
            }

            filteredProducts.forEach(product => {
                const productDiv = document.createElement('div');
                productDiv.className = 'flex justify-between items-center p-3 border-b border-gray-100 last:border-b-0 hover:bg-blue-50 cursor-pointer rounded-lg';
                productDiv.innerHTML = `
                    <div>
                        <p class="font-semibold text-gray-800">${product.name}</p>
                        <p class="text-sm text-gray-500">ID: ${product.id}</p>
                        <p class="text-xs text-gray-400">Stock: ${product.stock}</p>
                    </div>
                    <button data-product-id="${product.id}" class="add-to-cart-btn bg-blue-500 hover:bg-blue-600 text-white text-sm font-bold py-2 px-4 rounded-lg shadow-sm transition duration-200">
                        Add (KSh ${product.price.toFixed(2)})
                    </button>
                `;
                productResultsList.appendChild(productDiv);
            });

            // Attach event listeners to new "Add" buttons
            document.querySelectorAll('.add-to-cart-btn').forEach(button => {
                button.addEventListener('click', async (event) => { // Made async to handle potential stock updates
                    const productId = event.target.dataset.productId;
                    await addToCart(productId); // Await addToCart
                    productSearchInput.value = ''; // Clear search bar
                    searchResultsDiv.classList.add('hidden'); // Hide search results
                });
            });
        }

        /**
         * Adds a product to the cart or increments its quantity.
         * @param {string} productId - The ID of the product to add.
         */
        async function addToCart(productId) {
            const productToAdd = products.find(p => p.id === productId);
            if (!productToAdd) {
                showToast(`Product with ID ${productId} not found.`, 'error');
                return;
            }

            const existingItemIndex = cart.findIndex(item => item.product.id === productId);

            if (existingItemIndex > -1) {
                if (cart[existingItemIndex].quantity < productToAdd.stock) {
                    cart[existingItemIndex].quantity++;
                    showToast(`${productToAdd.name} added to cart!`, 'success');
                } else {
                    showToast(`Not enough stock for ${productToAdd.name}.`, 'warning');
                    return; // Prevent adding if stock is insufficient
                }
            } else {
                if (productToAdd.stock > 0) {
                    cart.push({ product: productToAdd, quantity: 1 });
                    showToast(`${productToAdd.name} added to cart!`, 'success');
                } else {
                    showToast(`${productToAdd.name} is out of stock.`, 'error');
                    return; // Prevent adding if out of stock
                }
            }
            updateCartDisplay();
            calculateTotals();
        }

        /**
         * Updates the quantity of an item in the cart.
         * @param {string} productId - The ID of the product.
         * @param {number} change - The amount to change the quantity by (+1 or -1).
         */
        function updateCartItemQuantity(productId, change) {
            const itemIndex = cart.findIndex(item => item.product.id === productId);
            if (itemIndex > -1) {
                const currentItem = cart[itemIndex];
                const productInDb = products.find(p => p.id === productId);

                // If quantity increases, check stock
                if (change > 0 && currentItem.quantity + change > productInDb.stock) {
                    showToast(`Cannot add more ${currentItem.product.name}. Max stock reached.`, 'warning');
                    return;
                }

                // If quantity goes to 0 or less, require manager approval
                if (currentItem.quantity + change <= 0) {
                    pendingApprovalAction = () => {
                        const removedItemName = currentItem.product.name;
                        cart.splice(itemIndex, 1); // Remove item
                        updateCartDisplay();
                        calculateTotals();
                        showToast(`${removedItemName} removed from cart.`, 'info');
                    };
                    // Set details for logging
                    pendingApprovalActionDetails = { 
                        action: 'Adjust Quantity to Zero/Remove', 
                        itemName: currentItem.product.name 
                    };
                    showManagerApprovalModal();
                } else {
                    currentItem.quantity += change;
                    updateCartDisplay();
                    calculateTotals();
                    showToast(`${currentItem.product.name} quantity updated.`, 'info');
                }
            }
        }

        /**
         * Removes an item from the cart. Requires manager approval.
         * @param {string} productId - The ID of the product to remove.
         */
        function removeItemFromCart(productId) {
            const itemToRemove = cart.find(item => item.product.id === productId);
            if (!itemToRemove) return;

            pendingApprovalAction = () => {
                cart = cart.filter(item => item.product.id !== productId);
                updateCartDisplay();
                calculateTotals();
                showToast(`${itemToRemove.product.name} removed from cart.`, 'info');
            };
            // Set details for logging
            pendingApprovalActionDetails = { 
                action: 'Remove Item', 
                itemName: itemToRemove.product.name 
            };
            showManagerApprovalModal();
        }

        /**
         * Renders the current items in the cart table.
         */
        function updateCartDisplay() {
            cartItemsTableBody.innerHTML = ''; // Clear current cart display

            if (cart.length === 0) {
                emptyCartMessage.classList.remove('hidden');
            } else {
                emptyCartMessage.classList.add('hidden');
                cart.forEach(item => {
                    const itemVat = calculateItemVat(item.product, item.quantity);
                    const itemSubtotal = calculateItemSubtotal(item.product, item.quantity);

                    const row = document.createElement('tr');
                    row.className = 'bg-white hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="py-3 px-4 text-gray-800 font-medium">${item.product.name}</td>
                        <td class="py-3 px-4 text-gray-700">
                            <div class="flex items-center">
                                <button data-product-id="${item.product.id}" data-change="-1" class="qty-btn bg-red-400 hover:bg-red-500 text-white w-6 h-6 rounded-full flex items-center justify-center text-sm shadow-sm">-</button>
                                <span class="mx-2 font-bold">${item.quantity}</span>
                                <button data-product-id="${item.product.id}" data-change="1" class="qty-btn bg-green-400 hover:bg-green-500 text-white w-6 h-6 rounded-full flex items-center justify-center text-sm shadow-sm">+</button>
                                <button data-product-id="${item.product.id}" class="remove-item-btn ml-3 text-red-600 hover:text-red-800 text-lg">&times;</button>
                            </div>
                        </td>
                        <td class="py-3 px-4 text-gray-700">KSh ${item.product.price.toFixed(2)}</td>
                        <td class="py-3 px-4 text-gray-700">KSh ${itemVat.toFixed(2)}</td>
                        <td class="py-3 px-4 text-gray-900 font-semibold">KSh ${itemSubtotal.toFixed(2)}</td>
                    `;
                    cartItemsTableBody.appendChild(row);
                });

                // Attach event listeners for quantity buttons and remove buttons
                document.querySelectorAll('.qty-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const productId = event.target.dataset.productId;
                        const change = parseInt(event.target.dataset.change);
                        updateCartItemQuantity(productId, change);
                    });
                });

                document.querySelectorAll('.remove-item-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const productId = event.target.dataset.productId;
                        removeItemFromCart(productId);
                    });
                });
            }
        }

        /**
         * Generates the HTML content for the receipt.
         * @returns {string} HTML string of the receipt.
         */
        async function generateReceiptContent() { 
            const now = new Date();
            const transactionId = `TXN-${transactionIdCounter}`;
            transactionIdCounter++; // Increment for next transaction

            const storeName = "Prince Alex Store";
            const storeAddress = "123 Market Street, Nairobi, Kenya";
            const storeEmail = "info@princealexstore.com";
            const cashierName = cashierNameDisplay.textContent; // Get from display
            const tillNumber = "001"; 
            const serialNumber = "SN-POS-2024-001"; // Placeholder
            const cuInvoiceNumber = "CUINV-2024-001"; // Placeholder
            const cuDate = now.toLocaleDateString('en-GB'); // Placeholder date format
            const printedDate = now.toLocaleString();

            let itemsTableRows = '';
            let grossSaleValue = 0; // Sum of price * qty (before VAT)

            // Prepare cart items for saving (simplified structure)
            const salesCartItems = cart.map(item => ({
                id: item.product.id,
                name: item.product.name,
                quantity: item.quantity,
                price: item.product.price,
                vatRate: item.product.vatRate,
                amount: calculateItemSubtotal(item.product, item.quantity) // Amount includes VAT
            }));


            cart.forEach(item => {
                const itemVat = calculateItemVat(item.product, item.quantity);
                const itemPriceExclVat = item.product.price * item.quantity;
                const itemAmountInclVat = itemPriceExclVat + itemVat;

                grossSaleValue += itemPriceExclVat;

                itemsTableRows += `
                    <tr>
                        <td class="py-1 px-2 text-left">${item.product.name}</td>
                        <td class="py-1 px-2 text-center">${item.product.id}</td>
                        <td class="py-1 px-2 text-center">${item.quantity}</td>
                        <td class="py-1 px-2 text-right">${item.product.price.toFixed(2)}</td>
                        <td class="py-1 px-2 text-right">${itemAmountInclVat.toFixed(2)}</td>
                    </tr>
                `;
            });

            const totalBeforeVat = parseFloat(totalBeforeVatSpan.textContent.replace('KSh ', ''));
            const vatAmount = parseFloat(vatAmountSpan.textContent.replace('KSh ', ''));
            const grandTotal = parseFloat(grandTotalSpan.textContent.replace('KSh ', ''));
            let cashReceived = parseFloat(cashReceivedInput.value) || 0;
            let balance = parseFloat(balanceAmountSpan.textContent.replace('KSh ', ''));

            // Adjust received and balance for digital payments on receipt
            if (selectedPaymentMethod === 'Mpesa' || selectedPaymentMethod === 'Card') {
                cashReceived = grandTotal;
                balance = 0;
            }

            const totalSavings = 0.00; // Placeholder for total savings

            // Construct the sale object to save
            const saleData = {
                invoiceNo: transactionId,
                timestamp: now.toISOString(), // Use ISO string for Firestore
                cashierName: cashierName,
                tillNumber: tillNumber,
                cartItems: salesCartItems, // Store the simplified cart items
                paymentMethod: selectedPaymentMethod,
                grossSaleValue: grossSaleValue,
                totalBeforeVat: totalBeforeVat,
                vatAmount: vatAmount,
                grandTotal: grandTotal,
                receivedAmount: cashReceived,
                balancePaid: balance,
                totalSavings: totalSavings,
                serialNo: serialNumber,
                cuInvoiceNo: cuInvoiceNumber,
                cuDate: cuDate,
                printedDate: printedDate
            };
            
            // Save the completed sale to Firestore
            await saveSaleToFirestore(saleData); 
            // Update stock in Firestore
            await updateStockAfterSale(saleData.cartItems);

            return `
                <div class="text-center mb-4">
                    <img src="https://placehold.co/80x80/000/fff?text=STORE+LOGO" alt="Store Logo" class="mx-auto mb-2 rounded-full">
                    <h2 class="text-2xl font-bold text-gray-900">${storeName}</h2>
                    <p class="text-sm text-gray-600">${storeAddress}</p>
                    <p class="text-sm text-gray-600">Email: ${storeEmail}</p>
                </div>
                <hr>
                <h3 class="text-xl font-bold text-center my-4">TAX INVOICE</h3>
                <hr>
                <div class="my-4 text-gray-700">
                    <div class="flex justify-between mb-1"><span>Invoice No:</span><span>${transactionId}</span></div>
                    <div class="flex justify-between mb-1"><span>Date:</span><span>${now.toLocaleDateString()}</span></div>
                    <div class="flex justify-between mb-1"><span>Time:</span><span>${now.toLocaleTimeString()}</span></div>
                    <div class="flex justify-between mb-1"><span>Cashier:</span><span>${cashierName}</span></div>
                    <div class="flex justify-between mb-1"><span>Till No:</span><span>${tillNumber}</span></div>
                </div>
                <hr>
                <div class="my-4">
                    <h3 class="font-bold text-lg mb-2">Products Bought:</h3>
                    <table class="min-w-full text-sm">
                        <thead>
                            <tr class="border-b border-gray-300">
                                <th class="py-1 px-2 text-left">Item</th>
                                <th class="py-1 px-2 text-center">Barcode</th>
                                <th class="py-1 px-2 text-center">Qty</th>
                                <th class="py-1 px-2 text-right">Price</th>
                                <th class="py-1 px-2 text-right">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsTableRows}
                        </tbody>
                    </table>
                </div>
                <hr>
                <div class="my-4 text-gray-800">
                    <div class="flex justify-between mb-1">
                        <span>Gross Sale Value:</span>
                        <span>${formatCurrency(grossSaleValue)}</span>
                    </div>
                    <div class="flex justify-between mb-1">
                        <span>Net Payable:</span>
                        <span>${formatCurrency(totalBeforeVat)}</span>
                    </div>
                    <div class="flex justify-between mb-1">
                        <span>Received Amount:</span>
                        <span>${formatCurrency(cashReceived)}</span>
                    </div>
                    <div class="flex justify-between mb-1">
                        <span>Balance Paid:</span>
                        <span>${formatCurrency(balance)}</span>
                    </div>
                    <div class="flex justify-between text-lg font-bold mt-2">
                        <span>Total Savings:</span>
                        <span>${formatCurrency(totalSavings)}</span>
                    </div>
                </div>
                <hr>
                <div class="my-4 text-gray-800">
                    <p>Payment Method: <span class="font-semibold">${selectedPaymentMethod || 'N/A'}</span></p>
                    ${selectedPaymentMethod === 'Mpesa' ? `<p>M-PESA Code: MP${Math.random().toString(36).substring(2, 10).toUpperCase()}</p>` : ''}
                </div>
                <hr>
                <div class="my-4 text-gray-800">
                    <h3 class="font-bold text-lg mb-2">Tax Summary:</h3>
                    <div class="flex justify-between mb-1">
                        <span>VAT (16%):</span>
                        <span>${formatCurrency(totalBeforeVat)}</span>
                        <span>${formatCurrency(vatAmount)}</span>
                    </div>
                </div>
                <hr>
                <div class="text-center mt-4">
                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=${encodeURIComponent(`Transaction ID: ${transactionId}, Total: ${grandTotal}`)}" alt="QR Code for Verification" class="mx-auto mb-2">
                    <p class="text-sm text-gray-600">Scan for Verification</p>
                    <div class="flex justify-between text-sm text-gray-600 mb-1 mt-2">
                        <span>Serial No:</span>
                        <span>${serialNumber}</span>
                    </div>
                    <div class="flex justify-between text-sm text-gray-600 mb-1">
                        <span>CU Invoice No:</span>
                        <span>${cuInvoiceNumber}</span>
                    </div>
                    <div class="flex justify-between text-sm text-gray-600 mb-1">
                        <span>CU Date:</span>
                        <span>${cuDate}</span>
                    </div>
                    <p class="text-sm text-gray-600 mt-2">Printed Date: ${printedDate}</p>
                    <p class="text-sm text-gray-600 mt-4">Thank you for shopping with us!</p>
                </div>
            `;
        }

        /**
         * Displays the receipt modal with generated content.
         */
        async function showReceipt() { 
            receiptContentBody.innerHTML = await generateReceiptContent(); 
            receiptModal.style.display = 'flex'; // Show the modal
        }

        /**
         * Hides the receipt modal.
         */
        function hideReceipt() {
            receiptModal.style.display = 'none'; // Hide the modal
        }

        /**
         * Handles the printing of the receipt.
         */
        function printReceipt() {
            if (cart.length === 0) {
                showToast('Cart is empty. Nothing to print.', 'warning');
                return;
            }
            showReceipt(); 
            setTimeout(() => {
                const printContents = receiptContentBody.innerHTML;
                const originalContents = document.body.innerHTML;

                // Create a new window for printing
                const printWindow = window.open('', '_blank');
                printWindow.document.write('<html><head><title>Receipt</title>');
                // Include basic styles for printing
                printWindow.document.write('<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">');
                printWindow.document.write('<style>');
                printWindow.document.write(`
                    body { font-family: 'Inter', sans-serif; margin: 0; padding: 1rem; }
                    .receipt-content { width: 100%; max-width: 400px; margin: 0 auto; padding: 0; }
                    .receipt-content hr { border-top: 1px dashed #cbd5e0; margin: 1rem 0; }
                    .text-center { text-align: center; }
                    .mb-4 { margin-bottom: 1rem; }
                    .text-2xl { font-size: 1.5rem; }
                    .font-bold { font-weight: 700; }
                    .text-gray-900 { color: #1a202c; }
                    .text-sm { font-size: 0.875rem; }
                    .text-gray-600 { color: #4a5568; }
                    .my-4 { margin-top: 1rem; margin-bottom: 1rem; }
                    .text-gray-700 { color: #2d3748; }
                    .font-semibold { font-weight: 600; }
                    .text-lg { font-size: 1.125rem; }
                    .flex { display: flex; }
                    .justify-between { justify-content: space-between; }
                    .text-xs { font-size: 0.75rem; }
                    .ml-4 { margin-left: 1rem; }
                    .mx-auto { margin-left: auto; margin-right: auto; }
                    img { display: block; }
                    table { width: 100%; border-collapse: collapse; }
                    th, td { padding: 0.25rem 0.5rem; border-bottom: 1px solid #eee; }
                    th { text-align: left; }
                    td { text-align: right; }
                    td:first-child { text-align: left; }
                `);
                printWindow.document.write('</style></head><body>');
                printWindow.document.write('<div class="receipt-content">');
                printWindow.document.write(printContents);
                printWindow.document.write('</div></body></html>');
                printWindow.document.close();
                printWindow.focus();
                printWindow.print();
                printWindow.close();
                hideReceipt(); // Hide modal after print command
            }, 50); // Small delay
        }

        /**
         * Displays the manager approval modal.
         */
        function showManagerApprovalModal() {
            managerCardIdInput.value = '';
            managerCodeInput.value = '';
            managerApprovalModal.style.display = 'flex';
            // Hide scanner elements by default when modal opens
            managerReaderDiv.classList.add('hidden');
            stopManagerScannerBtn.classList.add('hidden');
            startManagerScannerBtn.classList.remove('hidden'); // Ensure start button is visible
            managerCardIdInput.focus(); // Focus on card ID input
        }

        /**
         * Hides the manager approval modal.
         */
        function hideManagerApprovalModal() {
            managerApprovalModal.style.display = 'none';
            pendingApprovalAction = null; // Clear pending action
            pendingApprovalActionDetails = { action: '', itemName: '' }; // Clear details
            stopManagerScanner(); // Ensure manager scanner is stopped when modal closes
        }

        /**
         * Validates manager credentials from Firestore.
         * @param {string} cardId - The card ID entered or scanned.
         * @param {string} code - The code entered.
         * @returns {Promise<boolean>} True if credentials are valid, false otherwise.
         */
        async function validateManager(cardId, code) {
            try {
                const q = query(usersCol, where("role", "==", "manager"));
                const snapshot = await getDocs(q);

                let approved = false;
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    if ((cardId && data.cardId === cardId) || (code && data.code === code)) {
                        approved = true;
                    }
                });
                return approved;
            } catch (error) {
                console.error("Error validating manager credentials:", error);
                showToast("Error verifying manager. Please try again.", "error");
                return false;
            }
        }

        /**
         * Logs a manager approval action to Firestore.
         * @param {string} managerIdentifier - The card ID or code used by the manager.
         * @param {string} action - The action approved (e.g., "Remove Item", "Adjust Quantity Down").
         * @param {string} itemName - The name of the item involved in the action.
         * @param {string} cashierName - The name of the cashier.
         */
        async function logManagerApproval(managerIdentifier, action, itemName, cashierName) {
            try {
                await addDoc(managerLogsCol, {
                    managerIdentifier: managerIdentifier,
                    action: action,
                    item: itemName,
                    cashier: cashierName,
                    timestamp: new Date().toISOString()
                });
                console.log("Manager approval logged to Firestore.");
            } catch (error) {
                console.error("Error logging manager approval:", error);
                showToast("Failed to log manager approval action.", "error");
            }
        }

        /**
         * Validates manager approval for certain actions.
         */
        async function validateManagerApproval() { 
            const cardId = managerCardIdInput.value.trim();
            const code = managerCodeInput.value.trim();

            const approved = await validateManager(cardId, code);

            if (approved) {
                hideManagerApprovalModal();
                if (pendingApprovalAction) {
                    pendingApprovalAction(); // Execute the stored action (remove item/update quantity)
                    showToast('Manager approval successful!', 'success');
                    
                    // Log the manager approval
                    const managerIdentifier = cardId || code; // Use whichever was provided
                    const cashierName = cashierNameDisplay.textContent;
                    await logManagerApproval(
                        managerIdentifier, 
                        pendingApprovalActionDetails.action, 
                        pendingApprovalActionDetails.itemName, 
                        cashierName
                    );
                }
            } else {
                showToast('Invalid Manager credentials. Please try again.', 'error');
                managerCardIdInput.value = '';
                managerCodeInput.value = '';
                managerCardIdInput.focus();
            }
        }

        /**
         * Loads products from Firestore.
         */
        async function loadProducts() {
            try {
                const snapshot = await getDocs(productsCol);
                products = snapshot.docs.map(doc => ({
                    id: doc.id, // Firestore doc ID = barcode or productId
                    ...doc.data()
                }));
                console.log("Products loaded:", products);
                updateCartDisplay();
                calculateTotals();
            } catch (error) {
                console.error("Error loading products from Firestore:", error);
                showToast("Failed to load products. Please check console.", "error");
            }
        }

        /**
         * Updates stock in Firestore after a sale.
         * @param {Array<object>} cartItems - Items in the completed sale.
         */
        async function updateStockAfterSale(cartItems) {
            for (let item of cartItems) {
                const productRef = doc(db, "products", item.id);
                const productInDb = products.find(p => p.id === item.id); // Find the current product in our local 'products' array
                if (productInDb) {
                    const newStock = productInDb.stock - item.quantity;
                    await updateDoc(productRef, {
                        stock: newStock >= 0 ? newStock : 0 // Ensure stock doesn't go negative in DB
                    });
                    // Also update the local 'products' array to reflect new stock
                    productInDb.stock = newStock >= 0 ? newStock : 0;
                }
            }
            console.log("Stock updated in Firestore.");
        }

        /**
         * Saves a completed sale transaction to Firestore.
         * @param {object} saleData - The completed sale object.
         */
        async function saveSaleToFirestore(saleData) {
            try {
                await addDoc(salesCol, saleData);
                console.log("Sale saved to Firestore:", saleData);
            } catch (error) {
                console.error("Error saving sale to Firestore:", error);
                showToast("Failed to save sale. Please check console.", "error");
            }
        }


        /**
         * Resets the POS system to a fresh state after a completed sale.
         */
        function resetPOS() {
            cart = [];
            selectedPaymentMethod = null;
            paymentConfirmed = false; // Reset payment confirmation
            cashReceivedInput.value = '';
            balanceAmountSpan.textContent = formatCurrency(0);
            document.querySelectorAll('.payment-btn').forEach(btn => {
                btn.classList.remove('ring-2', 'ring-offset-2', 'ring-blue-500');
            });
            cashPaymentSection.classList.add('hidden');
            digitalPaymentStatusDiv.classList.add('hidden'); // Hide digital payment status
            digitalPaymentMessage.textContent = '';
            digitalPaymentDetails.textContent = '';
            updateCartDisplay();
            calculateTotals();
        }

        // --- Product Barcode Scanner Functions ---
        function startScanner() {
            // If scanner already exists or is in a scanning state, don't restart
            if (html5QrcodeScanner && html5QrcodeScanner.isScanning || isScanningProduct) {
                showToast("Product scanner is already running.", "info");
                return;
            }

            isScanningProduct = true; // Set scanning flag
            productScannerMessage.classList.remove('hidden'); // Show initializing message
            const qrCodeReaderElement = document.getElementById("reader");
            stopScannerBtn.classList.remove('hidden'); // Show the stop button

            // Define what happens when a barcode is successfully scanned
            async function onScanSuccess(decodedText, decodedResult) {
                // Debounce logic: only process if different from last scanned or if enough time has passed
                if (!lastScannedCode || lastScannedCode !== decodedText) {
                    lastScannedCode = decodedText;
                    playBeep(); // Play beep sound on success
                    await addToCart(decodedText); // Call your function to handle the product
                    productSearchInput.value = decodedText; // Populate search input with scanned code
                    // Set a timeout to clear the lastScannedCode after a debounce period (e.g., 800ms)
                    setTimeout(() => { lastScannedCode = null; }, 800); 
                }
                // Do NOT stop scanner here; allow continuous scanning
            }

            // Define what happens when scan error occurs
            function onScanError(errorMessage) {
                // console.warn(`Scan error: ${errorMessage}`); // Log errors for debugging, but don't show to user constantly
            }

            // Define the scanner
            html5QrcodeScanner = new Html5Qrcode("reader");
            // Optimized config: Higher FPS, smaller QR box, disableFlip
            const config = { 
                fps: 30, // Increased FPS for smoother scanning
                qrbox: { width: 200, height: 200 }, // Reduced QR box size for faster decode
                disableFlip: true // Can improve performance on some devices
            };

            html5QrcodeScanner.start(
                { facingMode: "environment" }, // Use back camera for better performance
                config,
                onScanSuccess,
                onScanError // Pass error handler
            ).then(() => {
                productScannerMessage.classList.add('hidden'); // Hide message once camera starts
            }).catch(err => {
                console.error("Error starting scanner:", err);
                showToast("Error starting scanner. Please ensure camera access is granted.", "error");
                stopScannerBtn.classList.add('hidden'); // Hide stop button if scanner fails to start
                isScanningProduct = false; // Reset flag on error
                productScannerMessage.classList.add('hidden'); // Hide message on error
            });
        }

        function stopScanner() {
            if (html5QrcodeScanner && html5QrcodeScanner.isScanning) { // Check if scanner is active
                html5QrcodeScanner.stop().then(() => {
                    html5QrcodeScanner.clear();
                    document.getElementById("reader").innerHTML = ''; // Clear scanner view
                    html5QrcodeScanner = null; // Reset scanner instance
                    stopScannerBtn.classList.add('hidden'); // Hide the stop button
                    showToast("Product scanner stopped.", "info");
                    isScanningProduct = false; // Reset scanning flag
                    productScannerMessage.classList.add('hidden'); // Hide message
                    lastScannedCode = null; // Reset debounce variable when scanner is explicitly stopped
                }).catch(err => {
                    console.error("Error stopping scanner:", err);
                    showToast("Error stopping scanner.", "error");
                    isScanningProduct = false; // Reset scanning flag even on stop error
                    productScannerMessage.classList.add('hidden'); // Hide message
                    lastScannedCode = null; // Reset debounce variable on stop error
                });
            } else if (html5QrcodeScanner) {
                 // If scanner object exists but isn't scanning, just clear it
                 html5QrcodeScanner.clear();
                 document.getElementById("reader").innerHTML = '';
                 html5QrcodeScanner = null;
                 stopScannerBtn.classList.add('hidden');
                 isScanningProduct = false; // Reset scanning flag
                 productScannerMessage.classList.add('hidden'); // Hide message
                 lastScannedCode = null; // Reset debounce variable
            }
        }

        // --- Manager Card Scanner Functions ---
        function startManagerScanner() {
            if (html5QrcodeManagerScanner && html5QrcodeManagerScanner.isScanning || isScanningManager) {
                showToast("Manager scanner is already running.", "info");
                return;
            }

            isScanningManager = true; // Set scanning flag
            managerScannerMessage.classList.remove('hidden'); // Show initializing message
            managerReaderDiv.classList.remove('hidden'); // Show manager scanner div
            stopManagerScannerBtn.classList.remove('hidden'); // Show stop button
            startManagerScannerBtn.classList.add('hidden'); // Hide start button

            function onScanSuccessManager(decodedText, decodedResult) {
                // Only process if not debouncing (no explicit debounce for manager as it's a single scan)
                if (isScanningManager) { // Check the flag again
                    console.log(`Manager Card Scanned: ${decodedText}`);
                    playBeep(); // Play beep sound on success
                    managerCardIdInput.value = decodedText; // Populate input with scanned ID
                    stopManagerScanner(); // Stop scanner after successful scan
                    validateManagerApproval(); // Automatically try to approve
                }
            }

            function onScanErrorManager(errorMessage) {
                // console.warn(`Manager Scan error: ${errorMessage}`);
            }

            html5QrcodeManagerScanner = new Html5Qrcode("managerReader");
            // Optimized config: Higher FPS, smaller QR box, disableFlip
            const config = { 
                fps: 30, // Increased FPS
                qrbox: { width: 200, height: 200 }, // Smaller QR box for manager card
                disableFlip: true // Can improve performance on some devices
            }; 

            html5QrcodeManagerScanner.start(
                { facingMode: "environment" }, // Use back camera
                config,
                onScanSuccessManager,
                onScanErrorManager
            ).then(() => {
                managerScannerMessage.classList.add('hidden'); // Hide message once camera starts
            }).catch(err => {
                console.error("Error starting manager scanner:", err);
                showToast("Error starting manager scanner. Please ensure camera access is granted.", "error");
                managerReaderDiv.classList.add('hidden');
                stopManagerScannerBtn.classList.add('hidden');
                startManagerScannerBtn.classList.remove('hidden'); // Show start button again if failed
                isScanningManager = false; // Reset flag on error
                managerScannerMessage.classList.add('hidden'); // Hide message on error
            });
        }

        function stopManagerScanner() {
            if (html5QrcodeManagerScanner && html5QrcodeManagerScanner.isScanning) {
                html5QrcodeManagerScanner.stop().then(() => {
                    html5QrcodeManagerScanner.clear();
                    managerReaderDiv.innerHTML = '';
                    html5QrcodeManagerScanner = null;
                    managerReaderDiv.classList.add('hidden');
                    stopManagerScannerBtn.classList.add('hidden');
                    startManagerScannerBtn.classList.remove('hidden'); // Show start button
                    showToast("Manager scanner stopped.", "info");
                    isScanningManager = false; // Reset scanning flag
                    managerScannerMessage.classList.add('hidden'); // Hide message
                }).catch(err => {
                    console.error("Error stopping manager scanner:", err);
                    showToast("Error stopping manager scanner.", "error");
                    isScanningManager = false; // Reset scanning flag even on stop error
                    managerScannerMessage.classList.add('hidden'); // Hide message
                });
            } else if (html5QrcodeManagerScanner) {
                // If scanner object exists but isn't scanning, just clear it
                html5QrcodeManagerScanner.clear();
                managerReaderDiv.innerHTML = '';
                html5QrcodeManagerScanner = null;
                managerReaderDiv.classList.add('hidden');
                stopManagerScannerBtn.classList.add('hidden');
                startManagerScannerBtn.classList.remove('hidden'); // Show start button
                isScanningManager = false; // Reset scanning flag
                managerScannerMessage.classList.add('hidden'); // Hide message
            }
        }


        // Expose functions to the global scope for onclick attributes
        window.startScanner = startScanner;
        window.stopScanner = stopScanner;
        window.startManagerScanner = startManagerScanner; // Expose new function
        window.stopManagerScanner = stopManagerScanner;   // Expose new function


        // --- Event Listeners ---

        // Product Search Input
        productSearchInput.addEventListener('input', (event) => {
            const searchTerm = event.target.value.toLowerCase();
            if (searchTerm.length > 0) {
                searchResultsDiv.classList.remove('hidden');
                const filtered = products.filter(product =>
                    product.name.toLowerCase().includes(searchTerm) ||
                    product.id.includes(searchTerm)
                );
                renderProducts(filtered);
            } else {
                searchResultsDiv.classList.add('hidden');
                productResultsList.innerHTML = '';
            }
        });

        // Payment Method Selection
        document.querySelectorAll('.payment-btn').forEach(button => {
            button.addEventListener('click', (event) => {
                // Reset payment confirmation and hide digital status
                paymentConfirmed = false;
                digitalPaymentStatusDiv.classList.add('hidden');
                digitalPaymentMessage.textContent = '';
                digitalPaymentDetails.textContent = '';

                // Remove active styling from all buttons
                document.querySelectorAll('.payment-btn').forEach(btn => {
                    btn.classList.remove('ring-2', 'ring-offset-2', 'ring-blue-500');
                });

                // Add active styling to the clicked button
                event.target.classList.add('ring-2', 'ring-offset-2', 'ring-blue-500');

                selectedPaymentMethod = event.target.id.replace('pay', '').replace('Btn', ''); // e.g., 'Cash', 'Mpesa', 'Card'

                if (selectedPaymentMethod === 'Cash') {
                    cashPaymentSection.classList.remove('hidden');
                    cashReceivedInput.focus();
                } else {
                    cashPaymentSection.classList.add('hidden');
                    balanceAmountSpan.textContent = formatCurrency(0); // Clear balance
                    cashReceivedInput.value = '';

                    // Disable payment buttons during processing
                    payCashBtn.disabled = true;
                    payMpesaBtn.disabled = true;
                    payCardBtn.disabled = true;

                    // Simulate digital payment processing
                    digitalPaymentStatusDiv.classList.remove('hidden');
                    digitalPaymentMessage.textContent = `Processing ${selectedPaymentMethod} payment...`;
                    digitalPaymentDetails.textContent = 'Please wait...';
                    showToast(`Initiating ${selectedPaymentMethod} payment...`, 'info');

                    setTimeout(() => {
                        paymentConfirmed = true;
                        digitalPaymentMessage.textContent = `${selectedPaymentMethod} Payment Confirmed!`;
                        const grandTotal = parseFloat(grandTotalSpan.textContent.replace('KSh ', ''));
                        cashReceivedInput.value = grandTotal; // Simulate full payment received for digital methods
                        balanceAmountSpan.textContent = formatCurrency(0); // Balance is 0 for digital payments

                        if (selectedPaymentMethod === 'Mpesa') {
                            const mpesaCode = `MP${Math.random().toString(36).substring(2, 10).toUpperCase()}`;
                            digitalPaymentDetails.textContent = `Transaction Code: ${mpesaCode}\nAmount: ${formatCurrency(grandTotal)}`;
                        } else if (selectedPaymentMethod === 'Card') {
                            digitalPaymentDetails.textContent = `Payment processed via external card machine.\nAmount: ${formatCurrency(grandTotal)}`;
                        }
                        showToast(`${selectedPaymentMethod} payment successful!`, 'success');

                        // Re-enable payment buttons after successful processing
                        payCashBtn.disabled = false;
                        payMpesaBtn.disabled = false;
                        payCardBtn.disabled = false;
                        calculateTotals(); // Re-calculate to enable complete sale button
                    }, 15000); // Changed to 15 seconds
                }

                calculateTotals(); // Initial calculation to update complete sale button state
            });
        });

        // Cash Received Input
        cashReceivedInput.addEventListener('input', () => {
            const grandTotal = parseFloat(grandTotalSpan.textContent.replace('KSh ', ''));
            const cashReceived = parseFloat(cashReceivedInput.value) || 0;
            const balance = cashReceived - grandTotal;
            balanceAmountSpan.textContent = formatCurrency(balance);
            calculateTotals(); // Re-calculate to enable/disable complete sale button
        });

        // Complete Sale Button
        completeSaleBtn.addEventListener('click', async () => { 
            if (cart.length === 0) {
                showToast('Cart is empty. Please add items before completing the sale.', 'error');
                return;
            }

            const grandTotal = parseFloat(grandTotalSpan.textContent.replace('KSh ', ''));
            const cashReceived = parseFloat(cashReceivedInput.value) || 0;

            if (selectedPaymentMethod === 'Cash' && cashReceived < grandTotal) {
                showToast('Cash received is less than the Grand Total. Please enter sufficient amount.', 'error');
                return;
            }

            // Simulate sale completion
            showToast(`Sale Completed! Total: ${formatCurrency(grandTotal)}`, 'success');
            await showReceipt(); // Show receipt after sale completion
            resetPOS(); // Reset POS for next transaction
        });

        // Print Receipt Button (main UI)
        printReceiptBtn.addEventListener('click', () => {
            printReceipt();
        });

        // Receipt Modal Close Button
        receiptCloseBtn.addEventListener('click', hideReceipt);

        // Print Button inside Receipt Modal
        printReceiptFromModalBtn.addEventListener('click', () => {
            printReceipt();
        });

        // Close modal when clicking outside of it
        window.addEventListener('click', (event) => {
            if (event.target === receiptModal) {
                hideReceipt();
            }
            if (event.target === managerApprovalModal) {
                hideManagerApprovalModal();
                showToast('Manager approval cancelled.', 'info');
            }
        });

        // Manager Approval Modal Buttons
        approveManagerBtn.addEventListener('click', validateManagerApproval);
        cancelManagerBtn.addEventListener('click', () => {
            hideManagerApprovalModal();
            showToast('Manager approval cancelled.', 'info');
        });

        // Manager Approval Modal Input Enter Key
        managerCardIdInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault(); // Prevent form submission
                validateManagerApproval();
            }
        });
        managerCodeInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault(); // Prevent form submission
                validateManagerApproval();
            }
        });

        // Admin Panel Button
        adminPanelBtn.addEventListener('click', () => {
            window.location.href = 'admin.html'; // This will navigate to admin.html in a real browser
        });


        // --- Keyboard Shortcuts ---
        document.addEventListener('keydown', (event) => {
            // Enter to add item (from search bar)
            if (event.key === 'Enter' && productSearchInput === document.activeElement) {
                const visibleResults = productResultsList.querySelectorAll('.add-to-cart-btn');
                if (visibleResults.length > 0) {
                    visibleResults[0].click(); // Simulate click on the first "Add" button
                    event.preventDefault(); // Prevent default Enter key behavior (e.g., form submission)
                }
            }

            // Ctrl + P to print
            if (event.ctrlKey && event.key === 'p') {
                event.preventDefault(); // Prevent browser's default print dialog
                printReceipt();
            }

            // F2 to focus payment input (cash received)
            if (event.key === 'F2') {
                event.preventDefault(); // Prevent default F2 behavior
                payCashBtn.click(); // Simulate clicking cash button to reveal input
                cashReceivedInput.focus();
            }
        });


        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            loadProducts(); // Load products from Firestore
        });
    </script>
</body>
</html>
