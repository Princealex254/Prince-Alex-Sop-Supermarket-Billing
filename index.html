<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prince Alex Store POS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden; /* Prevent horizontal scroll on mobile */
        }
        
        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            body {
                padding: 0.5rem;
            }
            
            .pos-container {
                border-radius: 1rem;
                margin: 0;
                min-height: calc(100vh - 1rem);
            }
            
            /* Header adjustments for mobile */
            header {
                padding: 1rem !important;
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            header .flex {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            /* Main content adjustments */
            main {
                padding: 1rem !important;
            }
            
            /* Search section mobile optimization */
            .search-section {
                margin-bottom: 1rem;
            }
            
            .search-section input {
                font-size: 16px; /* Prevent zoom on iOS */
                padding: 0.75rem;
            }
            
            /* Cart table mobile optimization */
            .cart-table {
                font-size: 0.875rem;
            }
            
            .cart-table th,
            .cart-table td {
                padding: 0.5rem 0.25rem;
            }
            
            /* Payment buttons mobile optimization */
            .payment-btn {
                padding: 0.75rem 0.5rem;
                font-size: 0.875rem;
                min-height: 44px; /* Touch-friendly minimum */
            }
            
            /* Complete sale button mobile optimization */
            #completeSaleBtn {
                padding: 1rem 0.75rem;
                font-size: 1rem;
                min-height: 48px;
            }
            
            /* Order summary mobile optimization */
            .order-summary {
                padding: 1rem;
            }
            
            /* Modal adjustments for mobile */
            .receipt-content,
            .manager-approval-content {
                width: 95%;
                max-width: none;
                margin: 1rem;
                padding: 1rem;
                max-height: 90vh;
                overflow-y: auto;
            }
            
            /* Scanner section mobile optimization */
            #scannerSection {
                padding: 1rem;
            }
            
            #scannerSection button {
                padding: 0.75rem 1rem;
                font-size: 0.875rem;
            }
        }
        
        @media (max-width: 480px) {
            /* Extra small screens */
            .pos-container {
                border-radius: 0.75rem;
                margin: 0;
            }
            
            header {
                padding: 0.75rem !important;
            }
            
            main {
                padding: 0.75rem !important;
            }
            
            /* Stack payment buttons vertically on very small screens */
            .payment-buttons {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .payment-btn {
                width: 100%;
            }
            
            /* Adjust cart table for very small screens */
            .cart-table {
                font-size: 0.75rem;
            }
            
            .cart-table th,
            .cart-table td {
                padding: 0.25rem;
            }
            
            /* Hide some less critical columns on very small screens */
            .cart-table .vat-column {
                display: none;
            }
        }
        .pos-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 1.5rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25), 0 0 0 1px rgba(255, 255, 255, 0.1);
            overflow: hidden;
            flex: 1;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .receipt-modal, .manager-approval-modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .receipt-modal.show, .manager-approval-modal.show {
            display: flex;
            opacity: 1;
        }
        .receipt-content, .manager-approval-content {
            background-color: #fff;
            margin: auto;
            padding: 1.5rem;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 320px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            position: relative;
            font-size: 0.75rem;
            line-height: 1.2;
            transform: scale(0.9);
            transition: transform 0.3s ease-in-out;
        }
        .receipt-modal.show .receipt-content, .manager-approval-modal.show .manager-approval-content {
            transform: scale(1);
        }
        .receipt-content hr {
            border-top: 1px dashed #cbd5e0;
            margin: 0.75rem 0;
        }
        .receipt-content table {
            font-size: 0.7rem;
        }

        /* Toast Alert Styling */
        #toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1001;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .toast {
            padding: 1rem 1.5rem;
            border-radius: 1rem;
            color: white;
            font-weight: 600;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.25), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transform: translateY(-20px) scale(0.95);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
        .toast.success { background-color: #10B981; /* Green-500 */ }
        .toast.error { background-color: #EF4444; /* Red-500 */ }
        .toast.info { background-color: #3B82F6; /* Blue-500 */ }
        .toast.warning { background-color: #F59E0B; /* Yellow-500 */ }

        /* Scanner message styling */
        .scanner-message {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.7) 100%);
            backdrop-filter: blur(10px);
            color: #4a5568;
            font-weight: 600;
            z-index: 10; /* Above the video feed */
            border-radius: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .scanner-message .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4a5568;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin-bottom: 0.5rem;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .search-input-container {
            position: relative;
        }
        .clear-search-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #ccc;
            cursor: pointer;
            line-height: 1;
            display: none;
        }
        .search-input-container:hover .clear-search-btn {
            display: block;
        }
        
        @media print {
            body * {
                visibility: hidden;
            }
            .receipt-modal, .receipt-modal * {
                visibility: visible;
            }
            .receipt-modal {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: auto;
                background-color: #fff;
                box-shadow: none;
            }
            .receipt-content {
                width: 100%;
                max-width: none;
                margin: 0;
                padding: 0.5rem;
                box-shadow: none;
                border-radius: 0;
                font-size: 0.7rem;
            }
            .receipt-content hr {
                margin: 0.5rem 0;
            }
            .receipt-content table {
                font-size: 0.65rem;
            }
            .receipt-close-btn, #printReceiptFromModalBtn {
                display: none;
            }
            /* Hide toast container and manager approval modal when printing */
            #toast-container, .manager-approval-modal {
                display: none;
            }
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">

    <div id="cashierLogin" class="fixed inset-0 bg-gradient-to-br from-gray-900 via-blue-900 to-purple-900 bg-opacity-90 backdrop-blur-sm flex items-center justify-center z-[1002] transition-opacity duration-300">
      <div class="bg-white/95 backdrop-blur-md p-8 rounded-3xl shadow-2xl w-96 transition-transform duration-300 transform scale-95 border border-white/20">
        <div class="text-center mb-8">
          <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl flex items-center justify-center mx-auto mb-4">
            <span class="text-white text-2xl">üë§</span>
          </div>
          <h2 class="text-3xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">Cashier Login</h2>
          <p class="text-gray-600 mt-2">Enter your credentials to access the POS system</p>
        </div>
        <div class="space-y-6">
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
              <span class="text-gray-400 text-lg">üîê</span>
            </div>
        <input id="cashierCode" type="password" 
          placeholder="Scan Card or Enter PIN"
              class="w-full pl-12 pr-4 py-4 border-2 border-gray-200 rounded-2xl focus:outline-none focus:ring-4 focus:ring-blue-500/20 focus:border-blue-500 text-lg shadow-lg bg-white/80 backdrop-blur-sm transition-all duration-300">
          </div>
        <button onclick="cashierLogin()" 
            class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white px-6 py-4 rounded-2xl font-semibold transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center justify-center space-x-3">
            <span class="text-xl">üöÄ</span>
            <span>Login</span>
          </button>
          <p id="loginError" class="text-red-600 text-sm mt-2 hidden text-center bg-red-50 p-3 rounded-xl border border-red-200">‚ùå Invalid code, try again</p>
        </div>
      </div>
    </div>

    <div id="managerApproval" class="manager-approval-modal transition-opacity duration-300">
      <div class="manager-approval-content transition-transform duration-300 bg-white/95 backdrop-blur-md p-8 rounded-3xl shadow-2xl border border-white/20">
        <div class="text-center mb-8">
          <div class="w-16 h-16 bg-gradient-to-br from-red-500 to-orange-600 rounded-2xl flex items-center justify-center mx-auto mb-4">
            <span class="text-white text-2xl">üë®‚Äçüíº</span>
          </div>
          <h2 class="text-3xl font-bold bg-gradient-to-r from-red-600 to-orange-600 bg-clip-text text-transparent">Manager Approval Required</h2>
          <p class="text-gray-600 mt-2">This action requires manager authorization</p>
        </div>
        <div class="space-y-6">
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
              <span class="text-gray-400 text-lg">üîë</span>
            </div>
        <input id="managerCode" type="password" 
          placeholder="Manager PIN or Card ID"
              class="w-full pl-12 pr-4 py-4 border-2 border-gray-200 rounded-2xl focus:outline-none focus:ring-4 focus:ring-red-500/20 focus:border-red-500 text-lg shadow-lg bg-white/80 backdrop-blur-sm transition-all duration-300">
          </div>
        <button onclick="approveAction()" 
            class="w-full bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-700 hover:to-orange-700 text-white px-6 py-4 rounded-2xl font-semibold transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center justify-center space-x-3">
            <span class="text-xl">‚úÖ</span>
            <span>Approve Action</span>
          </button>
          <p id="approvalError" class="text-red-600 text-sm mt-2 hidden text-center bg-red-50 p-3 rounded-xl border border-red-200">‚ùå Invalid Manager Code</p>
        </div>
      </div>
    </div>

    <div id="refundModal" class="manager-approval-modal transition-opacity duration-300">
      <div class="manager-approval-content transition-transform duration-300 bg-white/95 backdrop-blur-md p-8 rounded-3xl shadow-2xl border border-white/20 max-w-4xl">
        <div class="text-center mb-8">
          <div class="w-16 h-16 bg-gradient-to-br from-yellow-500 to-orange-600 rounded-2xl flex items-center justify-center mx-auto mb-4">
            <span class="text-white text-2xl">‚Ü©Ô∏è</span>
          </div>
          <h2 class="text-3xl font-bold bg-gradient-to-r from-yellow-600 to-orange-600 bg-clip-text text-transparent">Process Refund</h2>
          <p class="text-gray-600 mt-2">Enter invoice number to process refund</p>
        </div>
        
        <div class="space-y-6">
          <!-- Invoice Number Input -->
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
              <span class="text-gray-400 text-lg">üßæ</span>
            </div>
            <input id="refundInvoiceNo" type="text" 
              placeholder="Enter Invoice Number (e.g., TXN-20240115-001)"
              class="w-full pl-12 pr-4 py-4 border-2 border-gray-200 rounded-2xl focus:outline-none focus:ring-4 focus:ring-yellow-500/20 focus:border-yellow-500 text-lg shadow-lg bg-white/80 backdrop-blur-sm transition-all duration-300">
          </div>
          
          <!-- Search Button -->
          <button id="searchRefundSaleBtn" 
            class="w-full bg-gradient-to-r from-yellow-600 to-orange-600 hover:from-yellow-700 hover:to-orange-700 text-white px-6 py-4 rounded-2xl font-semibold transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center justify-center space-x-3">
            <span class="text-xl">üîç</span>
            <span>Search Sale</span>
          </button>
          
          <!-- Sale Details Display -->
          <div id="refundSaleDetails" class="hidden bg-gradient-to-r from-blue-50 to-purple-50 p-6 rounded-2xl border border-blue-200">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Sale Details</h3>
            <div id="refundSaleInfo" class="space-y-3">
              <!-- Sale information will be populated here -->
            </div>
            
            <!-- Review Time Notice -->
            <div class="mt-4 bg-gradient-to-r from-yellow-50 to-orange-50 p-4 rounded-xl border border-yellow-200">
              <div class="flex items-center space-x-3">
                <span class="text-2xl">‚è∞</span>
                <div>
                  <p class="font-semibold text-yellow-800">Review Time: 24 Hours</p>
                  <p class="text-sm text-yellow-700">This refund request will be reviewed by management and approved within 24 hours.</p>
                </div>
              </div>
            </div>
            
            <!-- Refund Action Buttons -->
            <div id="refundActionButtons" class="mt-6 flex space-x-4">
              <button id="confirmRefundBtn" 
                class="flex-1 bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white px-6 py-3 rounded-xl font-semibold transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center justify-center space-x-2">
                <span class="text-lg">üì§</span>
                <span>Submit Refund Request</span>
              </button>
              <button id="cancelRefundBtn" 
                class="flex-1 bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white px-6 py-3 rounded-xl font-semibold transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center justify-center space-x-2">
                <span class="text-lg">‚ùå</span>
                <span>Cancel</span>
              </button>
            </div>
          </div>
          
          <!-- Error Messages -->
          <p id="refundError" class="text-red-600 text-sm mt-2 hidden text-center bg-red-50 p-3 rounded-xl border border-red-200"></p>
          <p id="refundSuccess" class="text-green-600 text-sm mt-2 hidden text-center bg-green-50 p-3 rounded-xl border border-green-200"></p>
        </div>
      </div>
    </div>


    <header class="bg-gradient-to-r from-indigo-600 via-purple-600 to-blue-600 text-white p-6 flex items-center justify-between shadow-2xl relative overflow-hidden">
        <div class="absolute inset-0 bg-gradient-to-r from-indigo-600/20 via-purple-600/20 to-blue-600/20"></div>
        <div class="relative z-10 flex items-center space-x-4">
            <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center backdrop-blur-sm">
                <span class="text-2xl">üè™</span>
            </div>
            <div>
                <h1 class="text-2xl font-bold bg-gradient-to-r from-white to-blue-100 bg-clip-text text-transparent">Prince Alex Store POS</h1>
                <p class="text-blue-100 text-sm">Professional Point of Sale System</p>
            </div>
        </div>
        <div class="relative z-10 flex items-center space-x-3">
            <div class="bg-white/10 backdrop-blur-sm rounded-xl px-4 py-2 border border-white/20">
                <span class="text-sm text-blue-100">Cashier:</span>
                <span id="cashierNameDisplay" class="font-semibold ml-2">Loading...</span>
            </div>
            
            <!-- Scanner Status -->
            <div id="scannerStatus" class="hidden bg-white/10 backdrop-blur-sm rounded-xl px-3 py-2 border border-white/20">
                <!-- Status will be populated by JavaScript -->
            </div>
            
            <!-- Invoice Counter Status -->
            <div id="invoiceCounterStatus" class="bg-white/10 backdrop-blur-sm rounded-xl px-3 py-2 border border-white/20">
                <span class="text-sm text-blue-100">Today's Invoices:</span>
                <span id="invoiceCounterDisplay" class="font-semibold ml-2">Loading...</span>
            </div>
            
            <!-- Scanner Mode Toggle -->
            <button id="scannerModeBtn" onclick="switchScannerMode()" class="bg-white/20 hover:bg-white/30 backdrop-blur-sm text-white font-semibold py-3 px-4 rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl border border-white/20 hover:scale-105 flex items-center space-x-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                <span class="text-sm">Camera</span>
            </button>
            
            <button id="adminPanelBtn" class="bg-white/20 hover:bg-white/30 backdrop-blur-sm text-white font-semibold py-3 px-6 rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl border border-white/20 hover:scale-105">Admin Panel</button>
            <button id="logoutBtn" class="bg-red-500/80 hover:bg-red-600 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl hover:scale-105">Logout</button>
            <button id="settingsBtn" class="bg-white/20 hover:bg-white/30 backdrop-blur-sm text-white p-3 rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl border border-white/20 hover:scale-105">‚öôÔ∏è</button>
        </div>
    </header>

    <main class="flex-1 p-4 sm:p-6 lg:p-8 flex justify-center items-start">
        <div class="pos-container flex flex-col lg:flex-row p-4 sm:p-6 lg:p-8 w-full max-w-6xl"> 
            <div class="lg:w-2/3 p-4 sm:p-6 bg-gradient-to-br from-white to-gray-50 rounded-2xl lg:rounded-r-none lg:border-r border-gray-200/50 shadow-inner">
                <div class="flex items-center space-x-3 mb-8">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center">
                        <span class="text-white text-lg">üõí</span>
                    </div>
                    <h1 class="text-3xl font-bold bg-gradient-to-r from-gray-800 to-gray-600 bg-clip-text text-transparent">Billing Panel</h1>
                </div>

                <div class="mb-8 flex flex-col sm:flex-row items-center gap-4">
                    <div class="search-input-container w-full sm:w-2/3 relative">
                        <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                            <span class="text-gray-400 text-lg">üîç</span>
                    </div>
                        <input type="text" id="productSearch" placeholder="Scan barcode or type product name..."
                               class="w-full pl-12 pr-12 py-4 border-2 border-gray-200 rounded-2xl focus:outline-none focus:ring-4 focus:ring-blue-500/20 focus:border-blue-500 text-lg shadow-lg bg-white/80 backdrop-blur-sm transition-all duration-300">
                        <button id="clearSearchBtn" class="clear-search-btn absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 text-2xl transition-colors duration-200">&times;</button>
                    </div>
                    <button onclick="startScanner()" class="w-full sm:w-1/3 bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-bold py-4 px-6 rounded-2xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center justify-center space-x-2">
                        <span class="text-xl">üì∑</span>
                        <span>Scan Barcode</span>
                    </button>
                </div>

                <div id="reader" style="width: 100%; margin-top: 10px; position: relative;" class="rounded-2xl overflow-hidden shadow-lg">
                    <div id="productScannerMessage" class="scanner-message hidden">
                        <div class="spinner"></div>
                        <span>Initializing camera...</span>
                    </div>
                </div>
                <button onclick="stopScanner()" id="stopScannerBtn" class="hidden w-full bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-bold py-3 px-6 rounded-2xl mt-4 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center justify-center space-x-2">
                    <span class="text-xl">‚ùå</span>
                    <span>Close Scanner</span>
                </button>

                <div id="searchResults" class="mb-8 hidden">
                    <div class="flex items-center space-x-3 mb-4">
                        <div class="w-8 h-8 bg-gradient-to-br from-green-500 to-emerald-600 rounded-lg flex items-center justify-center">
                            <span class="text-white text-sm">üîç</span>
                        </div>
                        <h2 class="text-xl font-semibold text-gray-700">Search Results</h2>
                    </div>
                    <div id="productResultsList" class="max-h-80 overflow-y-auto border-2 border-gray-200 rounded-2xl bg-gradient-to-br from-white to-gray-50 shadow-inner">
                        </div>
                </div>

                <div class="mb-8">
                    <div class="flex items-center space-x-3 mb-6">
                        <div class="w-8 h-8 bg-gradient-to-br from-orange-500 to-red-600 rounded-lg flex items-center justify-center">
                            <span class="text-white text-sm">üõí</span>
                        </div>
                        <h2 class="text-xl font-semibold text-gray-700">Current Cart</h2>
                    </div>
                    <div class="overflow-x-auto rounded-2xl shadow-xl border-2 border-gray-200/50">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gradient-to-r from-blue-600 to-purple-600 text-white">
                                <tr>
                                    <th class="py-4 px-6 text-left text-sm font-semibold rounded-tl-2xl">Item Name</th>
                                    <th class="py-4 px-6 text-left text-sm font-semibold">Qty</th>
                                    <th class="py-4 px-6 text-left text-sm font-semibold">Price</th>
                                    <th class="py-4 px-6 text-left text-sm font-semibold">VAT</th>
                                    <th class="py-4 px-6 text-left text-sm font-semibold rounded-tr-2xl">Subtotal</th>
                                </tr>
                            </thead>
                            <tbody id="cartItems" class="divide-y divide-gray-200">
                                <tr id="emptyCartMessage">
                                    <td colspan="5" class="py-8 px-6 text-center text-gray-500 bg-gradient-to-br from-gray-50 to-gray-100">
                                        <div class="flex flex-col items-center space-y-2">
                                            <span class="text-4xl">üõí</span>
                                            <span class="text-lg font-medium">Cart is empty</span>
                                            <span class="text-sm">Add items to get started!</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="lg:w-1/3 p-4 sm:p-6 bg-gradient-to-br from-gray-50 to-gray-100 rounded-2xl lg:rounded-l-none mt-4 sm:mt-6 lg:mt-0 shadow-inner border border-gray-200/50">
                <div class="flex items-center justify-center space-x-3 mb-8">
                    <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl flex items-center justify-center">
                        <span class="text-white text-lg">üìä</span>
                    </div>
                    <h2 class="text-2xl font-bold bg-gradient-to-r from-gray-800 to-gray-600 bg-clip-text text-transparent">Order Summary</h2>
                </div>

                <div class="bg-white/80 backdrop-blur-sm p-6 rounded-2xl shadow-xl border border-white/50 mb-6">
                    <div class="space-y-4">
                        <div class="flex justify-between items-center p-3 bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl">
                        <span class="text-lg font-medium text-gray-700">Total (Before VAT):</span>
                            <span id="totalBeforeVat" class="text-lg font-semibold text-gray-900 bg-white px-3 py-1 rounded-lg shadow-sm">KSh 0.00</span>
                    </div>
                        <div class="flex justify-between items-center p-3 bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl">
                        <span class="text-lg font-medium text-gray-700">VAT Amount (<span id="vatRateDisplay">16</span>%):</span>
                            <span id="vatAmount" class="text-lg font-semibold text-gray-900 bg-white px-3 py-1 rounded-lg shadow-sm">KSh 0.00</span>
                    </div>
                        <div class="border-t-2 border-dashed border-gray-300 my-4"></div>
                        <div class="flex justify-between items-center p-4 bg-gradient-to-r from-blue-600 to-purple-600 rounded-xl text-white">
                            <span class="text-xl font-bold">Grand Total:</span>
                            <span id="grandTotal" class="text-2xl font-extrabold bg-white/20 px-4 py-2 rounded-xl">KSh 0.00</span>
                        </div>
                    </div>
                </div>

                <div class="bg-white/80 backdrop-blur-sm p-6 rounded-2xl shadow-xl border border-white/50 mb-6">
                    <div class="flex items-center space-x-3 mb-6">
                        <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-pink-600 rounded-lg flex items-center justify-center">
                            <span class="text-white text-sm">üí≥</span>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-700">Payment Options</h3>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-4">
                        <button id="payCashBtn" class="payment-btn bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold py-3 px-4 rounded-lg transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none" disabled>üíµ Cash</button>
                        <button id="payMpesaBtn" class="payment-btn bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold py-3 px-4 rounded-lg transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none" disabled>üì± M-PESA</button>
                        <button id="payCardBtn" class="payment-btn bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none" disabled>üí≥ Card</button>
                    </div>

                    <div id="cashPaymentSection" class="hidden bg-gradient-to-r from-green-50 to-emerald-50 p-4 rounded-2xl border border-green-200">
                        <label for="cashReceived" class="block text-gray-700 text-sm font-bold mb-3 flex items-center space-x-2">
                            <span>üí∞</span>
                            <span>Cash Received (KSh):</span>
                        </label>
                        <input type="number" id="cashReceived" placeholder="Enter amount"
                               class="w-full p-4 border-2 border-green-300 rounded-2xl focus:outline-none focus:ring-4 focus:ring-green-500/20 focus:border-green-500 text-lg shadow-lg bg-white/80 backdrop-blur-sm transition-all duration-300 mb-4">
                        <div class="flex justify-between items-center p-3 bg-white/60 rounded-xl">
                            <span class="text-lg font-medium text-gray-700">Balance:</span>
                            <span id="balanceAmount" class="text-xl font-bold text-red-600 bg-white px-3 py-1 rounded-lg shadow-sm">KSh 0.00</span>
                        </div>
                    </div>

                    <div id="digitalPaymentStatus" class="hidden text-center p-4 mt-4 rounded-2xl bg-gradient-to-r from-blue-50 to-purple-50 border border-blue-200">
                        <p id="digitalPaymentMessage" class="text-gray-700 font-semibold mb-2"></p>
                        <p id="digitalPaymentDetails" class="text-sm text-gray-600"></p>
                    </div>

                    <button id="completeSaleBtn" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-bold py-4 px-6 rounded-2xl text-xl transition-all duration-300 shadow-xl hover:shadow-2xl transform hover:scale-105 mt-6 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none flex items-center justify-center space-x-3" disabled>
                        <span class="text-2xl">‚úÖ</span>
                        <span>Complete Sale</span>
                    </button>
                </div>

                <div class="mt-6 flex flex-col space-y-3">
                    <button id="printReceiptBtn" class="w-full bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white font-bold py-4 px-6 rounded-2xl text-lg transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center justify-center space-x-3">
                        <span class="text-xl">üñ®Ô∏è</span>
                        <span>Print Receipt</span>
                        <span class="text-xs text-gray-300 bg-gray-800 px-2 py-1 rounded">Ctrl+P</span>
                    </button>
                    <button id="cancelSaleBtn" class="w-full bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-bold py-4 px-6 rounded-2xl text-lg transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center justify-center space-x-3">
                        <span class="text-xl">‚ùå</span>
                        <span>Cancel Current Sale</span>
                    </button>
                    <button id="refundSaleBtn" class="w-full bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 text-white font-bold py-4 px-6 rounded-2xl text-lg transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center justify-center space-x-3">
                        <span class="text-xl">‚Ü©Ô∏è</span>
                        <span>Process Refund</span>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <div id="receiptModal" class="receipt-modal">
        <div class="receipt-content">
            <button class="receipt-close-btn absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            <div id="receiptContentBody">
                </div>
            <div class="flex space-x-3 mt-4">
                <button id="printReceiptFromModalBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center space-x-2">
                    <span>üñ®Ô∏è</span>
                    <span>Print</span>
                </button>
                <button id="downloadReceiptBtn" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center space-x-2">
                    <span>üì•</span>
                    <span>Download</span>
                </button>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>

    <script type="module">
        //
        // üîë Firebase Security Rules (IMPORTANT!) üîë
        //
        // You are encountering "Missing or insufficient permissions" because your Firestore
        // database rules are not configured to allow the application to read and write data.
        //
        // To fix this, you need to go to your Firebase project console:
        // 1. Go to Firestore Database -> Rules tab.
        // 2. Replace the existing rules with the following for development purposes.
        //    (For production, you'll need more refined rules based on authentication.)
        //
        // rules_version = '2';
        // service cloud.firestore {
        //   match /databases/{database}/documents {
        //     // Allow read and write access to 'products', 'sales', 'users', and 'managerLogs'
        //     // for any authenticated user. For testing, you might even allow unauthenticated access
        //     // but ensure to tighten this for production!
        //     match /{document=**} {
        //       allow read, write: if true; // WARNING: This allows anyone to read/write!
        //                                   // Use this ONLY for initial setup/testing.
        //                                   // For production, consider: allow read, write: if request.auth != null;
        //     }
        //
        //     // More specific rules (example for authenticated users):
        //     // match /products/{productId} {
        //     //   allow read, write: if request.auth != null;
        //     // }
        //     // match /sales/{saleId} {
        //     //   allow read, write: if request.auth != null;
        //     // }
        //     // match /users/{userId} {
        //     //   allow read, write: if request.auth != null;
        //     // }
        //     // match /managerLogs/{logId} {
        //     //   allow read, write: if request.auth != null;
        //     // }
        //   }
        // }
        //
        // After updating the rules, publish them. Your application should then be able to
        // interact with Firestore correctly.
        //

        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, getDocs, setDoc, addDoc, updateDoc, deleteDoc, doc, query, where, onSnapshot, serverTimestamp, runTransaction, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Firebase config (yours)
        const firebaseConfig = {
            apiKey: "AIzaSyAUNs3WYS2mkvPvzRDfhyZFUbP2XpZjDQg",
            authDomain: "retailflow-pos-11726.firebaseapp.com",
            projectId: "retailflow-pos-11726",
            storageBucket: "retailflow-pos-11726.firebasestorage.app",
            messagingSenderId: "309314798354",
            appId: "1:309314798354:web:30784c2b2e7e42168629cb"
        };

        // Initialize Firebase + Firestore
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Firestore collection references
        const productsCol = collection(db, "products");
        const salesCol = collection(db, "sales");
        const usersCol = collection(db, "users"); // Users collection reference
        const managerLogsCol = collection(db, "managerLogs"); // New: Manager Logs collection reference (serves as audit trail)
        const refundRequestsCol = collection(db, "refundRequests"); // New: Refund Requests collection for admin approval
        const invoiceCountersCol = collection(db, "invoiceCounters"); // New: Invoice counters collection for atomic operations

        // --- Product Database (Initial Data) ---
        // This will now be loaded from Firestore
        let products = []; 
        let vatRate = 0.16; // Centralized VAT rate

        // --- Global Variables ---
        let cart = []; // Stores items currently in the cart
        let selectedPaymentMethod = null;
        let transactionIdCounter = 1000; // Simple counter for transaction IDs
        let currentDate = new Date().toDateString(); // Track current date for counter reset
        let pendingApprovalAction = null; // Stores the function to execute after manager approval
        let pendingApprovalActionDetails = { action: '', itemName: '' }; // Stores details for logging manager action
        let paymentConfirmed = false; // Tracks if a digital payment has been confirmed
        let html5QrcodeScanner; // Declare product scanner variable globally
        let lastScannedCode = null; // New: Debounce variable for product scanner
        let usbScannerConnected = false; // Track USB scanner connection status
        let scannerMode = 'camera'; // 'camera' or 'usb'
        let usbScannerInput = null; // Hidden input for USB scanner
        let currentCashier = null; // Stores the currently logged-in cashier object
        let inactivityTimer; // Timer for auto-logout
        const INACTIVITY_TIMEOUT_MINUTES = 5;
        let invoiceCounterUnsubscribe = null; // Unsubscribe function for invoice counter monitoring

        // --- DOM Elements ---
        const cashierLoginDiv = document.getElementById('cashierLogin'); // New: Login screen div
        const cashierCodeInput = document.getElementById('cashierCode'); // New: Cashier code input
        const loginErrorMsg = document.getElementById('loginError');     // New: Login error error message
        const productSearchInput = document.getElementById('productSearch');
        const clearSearchBtn = document.getElementById('clearSearchBtn'); // New: Clear search button
        const searchResultsDiv = document.getElementById('searchResults');
        const productResultsList = document.getElementById('productResultsList');
        const cartItemsTableBody = document.getElementById('cartItems');
        const emptyCartMessage = document.getElementById('emptyCartMessage');
        const totalBeforeVatSpan = document.getElementById('totalBeforeVat');
        const vatRateDisplay = document.getElementById('vatRateDisplay'); // New: VAT rate display
        const vatAmountSpan = document.getElementById('vatAmount');
        const grandTotalSpan = document.getElementById('grandTotal');
        const payCashBtn = document.getElementById('payCashBtn');
        const payMpesaBtn = document.getElementById('payMpesaBtn');
        const payCardBtn = document.getElementById('payCardBtn');
        const cashPaymentSection = document.getElementById('cashPaymentSection');
        const cashReceivedInput = document.getElementById('cashReceived');
        const balanceAmountSpan = document.getElementById('balanceAmount');
        const completeSaleBtn = document.getElementById('completeSaleBtn');
        const printReceiptBtn = document.getElementById('printReceiptBtn');
        const receiptModal = document.getElementById('receiptModal');
        const receiptContentBody = document.getElementById('receiptContentBody');
        const receiptCloseBtn = document.querySelector('.receipt-close-btn');
        const printReceiptFromModalBtn = document.getElementById('printReceiptFromModalBtn');
        const downloadReceiptBtn = document.getElementById('downloadReceiptBtn');
        const toastContainer = document.getElementById('toast-container');
        const cashierNameDisplay = document.getElementById('cashierNameDisplay');
        const stopScannerBtn = document.getElementById('stopScannerBtn'); // Get the new stop scanner button
        const adminPanelBtn = document.getElementById('adminPanelBtn'); // Get the new Admin Panel button
        const logoutBtn = document.getElementById('logoutBtn'); // Logout button
        const mainPosContent = document.querySelector('main'); // Reference to the main POS content area

        // Manager Approval Modal Elements
        const managerApprovalModal = document.getElementById('managerApproval'); 
        const managerCodeInput = document.getElementById('managerCode'); 
        const approvalError = document.getElementById('approvalError'); 

        // New buttons for manager actions
        const cancelSaleBtn = document.getElementById('cancelSaleBtn');
        const refundSaleBtn = document.getElementById('refundSaleBtn');

        // Refund Modal Elements
        const refundModal = document.getElementById('refundModal');
        const refundInvoiceNoInput = document.getElementById('refundInvoiceNo');
        const searchRefundSaleBtn = document.getElementById('searchRefundSaleBtn');
        const refundSaleDetails = document.getElementById('refundSaleDetails');
        const refundSaleInfo = document.getElementById('refundSaleInfo');
        const confirmRefundBtn = document.getElementById('confirmRefundBtn');
        const cancelRefundBtn = document.getElementById('cancelRefundBtn');
        const refundError = document.getElementById('refundError');
        const refundSuccess = document.getElementById('refundSuccess');


        // Scanner messages 
        const productScannerMessage = document.getElementById('productScannerMessage');


        // Digital Payment Status Elements
        const digitalPaymentStatusDiv = document.getElementById('digitalPaymentStatus');
        const digitalPaymentMessage = document.getElementById('digitalPaymentMessage');
        const digitalPaymentDetails = document.getElementById('digitalPaymentDetails');
        const invoiceCounterDisplay = document.getElementById('invoiceCounterDisplay');


        // --- Helper Functions ---
        
        /**
         * Gets the next available invoice number for today using atomic transactions.
         * Ensures uniqueness across all cashiers in real-time.
         */
        async function getNextInvoiceNumber() {
            const todayStr = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            const counterDocId = `counter_${todayStr}`;
            const counterDocRef = doc(invoiceCountersCol, counterDocId);
            
            try {
                // Use atomic transaction to ensure uniqueness
                const result = await runTransaction(db, async (transaction) => {
                    const counterDoc = await transaction.get(counterDocRef);
                    
                    let currentCount = 1000; // Start from 1000
                    
                    if (counterDoc.exists()) {
                        currentCount = counterDoc.data().count || 1000;
                    } else {
                        // Create new counter document for today
                        transaction.set(counterDocRef, {
                            date: todayStr,
                            count: 1000,
                            createdAt: serverTimestamp(),
                            lastUpdated: serverTimestamp()
                        });
                    }
                    
                    // Increment counter atomically
                    const newCount = currentCount + 1;
                    transaction.update(counterDocRef, {
                        count: newCount,
                        lastUpdated: serverTimestamp(),
                        lastCashier: currentCashier ? currentCashier.name : "Unknown"
                    });
                    
                    return newCount;
                });
                
                // Generate invoice number with the atomic counter
                const invoiceNumber = `TXN-${todayStr}-${String(result).padStart(3, '0')}`;
                
                console.log(`Generated unique invoice number: ${invoiceNumber}`);
                return invoiceNumber;
                
            } catch (error) {
                console.error("Error generating invoice number:", error);
                
                // Fallback: Use timestamp-based approach if transaction fails
                const fallbackNumber = `TXN-${todayStr}-${Date.now().toString().slice(-3)}`;
                console.warn(`Using fallback invoice number: ${fallbackNumber}`);
                return fallbackNumber;
            }
        }
        
        /**
         * Monitors invoice counter in real-time and updates the display.
         */
        function startInvoiceCounterMonitoring() {
            const todayStr = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            const counterDocId = `counter_${todayStr}`;
            const counterDocRef = doc(invoiceCountersCol, counterDocId);
            
            // Set up real-time listener for invoice counter
            const unsubscribe = onSnapshot(counterDocRef, (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    const count = data.count || 1000;
                    const lastCashier = data.lastCashier || "Unknown";
                    
                    // Update display with current count and next invoice number
                    const nextInvoice = `TXN-${todayStr}-${String(count + 1).padStart(3, '0')}`;
                    invoiceCounterDisplay.innerHTML = `
                        <span class="text-green-300">${count}</span>
                        <span class="text-xs text-blue-200 ml-1">(Next: ${nextInvoice})</span>
                    `;
                    
                    // Show toast when counter updates (but not on initial load)
                    if (count > 1000) {
                        // Message exists but hidden from user - only logs to console
                        console.log(`Invoice counter updated: ${count} invoices today`);
                    }
                } else {
                    // Counter doesn't exist yet, show default
                    const nextInvoice = `TXN-${todayStr}-001`;
                    invoiceCounterDisplay.innerHTML = `
                        <span class="text-green-300">0</span>
                        <span class="text-xs text-blue-200 ml-1">(Next: ${nextInvoice})</span>
                    `;
                }
            }, (error) => {
                console.error("Error monitoring invoice counter:", error);
                invoiceCounterDisplay.textContent = "Error";
            });
            
            return unsubscribe;
        }
        
        /**
         * Resets the auto-logout timer.
         */
        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(cashierLogout, INACTIVITY_TIMEOUT_MINUTES * 60 * 1000);
            console.log("Timer reset");
        }

        /**
         * Detects USB barcode scanner connection and sets up input handling.
         */
        function detectUSBScanner() {
            // Create hidden input for USB scanner
            usbScannerInput = document.createElement('input');
            usbScannerInput.type = 'text';
            usbScannerInput.style.position = 'absolute';
            usbScannerInput.style.left = '-9999px';
            usbScannerInput.style.opacity = '0';
            usbScannerInput.style.pointerEvents = 'none';
            usbScannerInput.placeholder = 'USB Scanner Input';
            document.body.appendChild(usbScannerInput);

            // Monitor for rapid keystrokes (typical of barcode scanners)
            let keystrokeBuffer = '';
            let keystrokeTimer = null;
            const SCANNER_TIMEOUT = 50; // ms between keystrokes

            document.addEventListener('keydown', (e) => {
                // Skip if it's a special key or modifier
                if (e.ctrlKey || e.altKey || e.metaKey || e.key === 'Tab' || e.key === 'Enter') {
                    return;
                }

                // Clear buffer if too much time has passed
                if (keystrokeTimer) {
                    clearTimeout(keystrokeTimer);
                }

                keystrokeBuffer += e.key;
                keystrokeTimer = setTimeout(() => {
                    // If buffer is long enough and contains only alphanumeric characters, it's likely a scanner
                    if (keystrokeBuffer.length >= 8 && /^[A-Za-z0-9]+$/.test(keystrokeBuffer)) {
                        handleUSBScannerInput(keystrokeBuffer);
                        usbScannerConnected = true;
                        updateScannerStatus();
                    }
                    keystrokeBuffer = '';
                }, SCANNER_TIMEOUT);
            });

            // Monitor USB device connections
            if (navigator.usb) {
                navigator.usb.addEventListener('connect', () => {
                    console.log('USB device connected');
                    checkForScannerDevice();
                });

                navigator.usb.addEventListener('disconnect', () => {
                    console.log('USB device disconnected');
                    usbScannerConnected = false;
                    updateScannerStatus();
                });
            }

            // Initial check for connected devices
            checkForScannerDevice();
        }

        /**
         * Checks for connected USB devices that might be scanners.
         */
        async function checkForScannerDevice() {
            if (!navigator.usb) {
                console.log('WebUSB not supported');
                return;
            }

            try {
                const devices = await navigator.usb.getDevices();
                const scannerDevices = devices.filter(device => {
                    // Common scanner device identifiers
                    const scannerVendorIds = [0x05E0, 0x05E1, 0x05E2, 0x05E3, 0x05E4, 0x05E5]; // Symbol/Zebra
                    const scannerProductNames = ['scanner', 'barcode', 'symbol', 'zebra', 'honeywell'];
                    
                    return scannerVendorIds.includes(device.vendorId) || 
                           scannerProductNames.some(name => 
                               device.productName?.toLowerCase().includes(name)
                           );
                });

                if (scannerDevices.length > 0) {
                    usbScannerConnected = true;
                    console.log('USB Scanner detected:', scannerDevices[0].productName);
                    updateScannerStatus();
                }
            } catch (error) {
                console.log('Error checking USB devices:', error);
            }
        }

        /**
         * Handles input from USB barcode scanner.
         */
        function handleUSBScannerInput(scannedCode) {
            console.log('USB Scanner input:', scannedCode);
            
            // Debounce: prevent multiple rapid scans
            if (lastScannedCode === scannedCode) {
                return;
            }
            lastScannedCode = scannedCode;

            // Clear the input field
            if (usbScannerInput) {
                usbScannerInput.value = '';
            }

            // Process the scanned code
            processScannedCode(scannedCode);
        }

        /**
         * Updates the scanner status display.
         */
        function updateScannerStatus() {
            const scannerStatusDiv = document.getElementById('scannerStatus');
            if (!scannerStatusDiv) return;

            if (usbScannerConnected) {
                scannerStatusDiv.innerHTML = `
                    <div class="flex items-center space-x-2 text-green-600">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                        </svg>
                        <span class="text-sm font-medium">USB Scanner Connected</span>
                    </div>
                `;
                scannerStatusDiv.classList.remove('hidden');
            } else {
                scannerStatusDiv.innerHTML = `
                    <div class="flex items-center space-x-2 text-yellow-600">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                        </svg>
                        <span class="text-sm font-medium">Camera Scanner Only</span>
                    </div>
                `;
                scannerStatusDiv.classList.remove('hidden');
            }
        }

        /**
         * Switches between camera and USB scanner modes.
         */
        function switchScannerMode() {
            if (scannerMode === 'camera') {
                if (usbScannerConnected) {
                    scannerMode = 'usb';
                    stopCameraScanner();
                    showToast('Switched to USB Scanner mode', 'info');
                } else {
                    showToast('No USB scanner detected. Using camera scanner.', 'warning');
                }
            } else {
                scannerMode = 'camera';
                startCameraScanner();
                showToast('Switched to Camera Scanner mode', 'info');
            }
            updateScannerModeDisplay();
        }

        /**
         * Updates the scanner mode display.
         */
        function updateScannerModeDisplay() {
            const scannerModeBtn = document.getElementById('scannerModeBtn');
            if (!scannerModeBtn) return;

            if (scannerMode === 'camera') {
                scannerModeBtn.innerHTML = `
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    Camera Scanner
                `;
            } else {
                scannerModeBtn.innerHTML = `
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    USB Scanner
                `;
            }
        }

        /**
         * Toggles the visibility and animation of a modal.
         * @param {HTMLElement} modal - The modal element to toggle.
         * @param {boolean} show - True to show, false to hide.
         */
        function toggleModal(modal, show) {
            if (show) {
                modal.classList.add('show');
            } else {
                modal.classList.remove('show');
            }
        }

        /**
         * Displays a toast notification.
         * @param {string} message - The message to display.
         * @param {'success'|'error'|'info'|'warning'} type - The type of toast (for styling).
         * @param {number} duration - How long the toast should be visible in ms.
         */
        function showToast(message, type = 'info', duration = 3000) {
            const toast = document.createElement('div');
            const icon = {
                success: '‚úÖ',
                error: '‚ùå',
                info: '‚ÑπÔ∏è',
                warning: '‚ö†Ô∏è'
            }[type] || '';
            toast.className = `toast ${type}`;
            toast.textContent = `${icon} ${message}`;
            toastContainer.appendChild(toast);

            // Trigger reflow to ensure transition plays
            void toast.offsetWidth;

            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove(), { once: true });
            }, duration);
        }

        /**
         * Plays a simple beep sound.
         */
        function playBeep() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.type = 'sine'; // Sine wave for a clean beep
                oscillator.frequency.setValueAtTime(880, audioContext.currentTime); // A4 note
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime); // Volume

                oscillator.start(audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + 0.1); // Short decay
                oscillator.stop(audioContext.currentTime + 0.1); // Stop after 0.1 seconds
            } catch (e) {
                console.warn("AudioContext not supported or error playing sound:", e);
            }
        }

        /**
         * Formats a number to currency string (KSh).
         * @param {number} amount - The amount to format.
         * @returns {string} Formatted currency string.
         */
        function formatCurrency(amount) {
            // Ensure amount is a number and handle potential NaN
            const numAmount = parseFloat(amount);
            if (isNaN(numAmount)) {
                return 'KSh 0.00';
            }
            return `KSh ${numAmount.toFixed(2)}`;
        }

        /**
         * Calculates VAT based on price and VAT rate.
         * Assumes VAT Exclusive pricing (price in DB excludes VAT).
         * @param {number} price - The price of the item (or subtotal of items).
         * @param {number} vatRate - The VAT rate (e.g., 0.16 for 16%).
         * @returns {{netPrice: number, vatAmount: number, total: number}} Object containing net price, VAT amount, and total.
         */
        function calculateVAT(price, vatRate) {
            // Price is VAT Exclusive, add it
            const vatAmount = price * vatRate;
            const total = price + vatAmount;
            return { netPrice: price, vatAmount, total };
        }

        /**
         * Calculates VAT for a single item.
         * @param {object} product - The product object.
         * @param {number} quantity - The quantity of the product.
         * @returns {number} The calculated VAT amount.
         */
        function calculateItemVat(product, quantity) {
            const { vatAmount } = calculateVAT(product.price * quantity, vatRate);
            return vatAmount;
        }

        /**
         * Calculates the subtotal for a single item (price * quantity + item VAT).
         * @param {object} product - The product object.
         * @param {number} quantity - The quantity of the product.
         * @returns {number} The calculated item subtotal.
         */
        function calculateItemSubtotal(product, quantity) {
            const { total } = calculateVAT(product.price * quantity, vatRate);
            return total;
        }

        /**
         * Updates the cart summary (total before VAT, VAT amount, grand total).
         * Also controls the complete sale button's disabled state.
         */
        function calculateTotals() {
            let totalBeforeVat = 0; // This will be the net amount
            let totalVatAmount = 0;

            cart.forEach(item => {
                const itemNetPrice = item.product.price * item.quantity;
                const { vatAmount } = calculateVAT(itemNetPrice, vatRate);
                
                totalBeforeVat += itemNetPrice;
                totalVatAmount += vatAmount;
            });

            const grandTotal = totalBeforeVat + totalVatAmount;

            totalBeforeVatSpan.textContent = formatCurrency(totalBeforeVat);
            vatAmountSpan.textContent = formatCurrency(totalVatAmount);
            grandTotalSpan.textContent = formatCurrency(grandTotal);

            // Logic for enabling/disabling complete sale button
            let enableCompleteSale = false;
            if (cart.length > 0) {
                if (selectedPaymentMethod === 'Cash') {
                    const cashReceived = parseFloat(cashReceivedInput.value) || 0;
                    enableCompleteSale = cashReceived >= grandTotal;
                } else if (selectedPaymentMethod === 'Mpesa' || selectedPaymentMethod === 'Card') {
                    enableCompleteSale = paymentConfirmed;
                }
            }
            completeSaleBtn.disabled = !enableCompleteSale;
            printReceiptBtn.disabled = cart.length === 0;

            // Disable payment buttons if cart is empty
            const paymentButtons = [payCashBtn, payMpesaBtn, payCardBtn];
            if (cart.length === 0) {
                paymentButtons.forEach(btn => btn.disabled = true);
                // Also reset selected payment method display if cart becomes empty
                selectedPaymentMethod = null;
                paymentConfirmed = false;
                cashPaymentSection.classList.add('hidden');
                digitalPaymentStatusDiv.classList.add('hidden');
                document.querySelectorAll('.payment-btn').forEach(btn => {
                    btn.classList.remove('ring-2', 'ring-offset-2', 'ring-blue-500');
                });
            } else {
                paymentButtons.forEach(btn => btn.disabled = false);
            }
        }

        /**
         * Renders products in the search results list.
         * @param {Array<object>} filteredProducts - Products to display.
         */
        function renderProducts(filteredProducts) {
            productResultsList.innerHTML = ''; // Clear previous results
            if (filteredProducts.length === 0) {
                productResultsList.innerHTML = '<p class="p-4 text-gray-500">No products found.</p>';
                return;
            }

            filteredProducts.forEach(product => {
                const productDiv = document.createElement('div');
                productDiv.className = 'flex justify-between items-center p-4 border-b border-gray-200/50 last:border-b-0 hover:bg-gradient-to-r hover:from-blue-50 hover:to-purple-50 cursor-pointer rounded-2xl transition-all duration-300 hover:shadow-lg hover:scale-105 m-2';
                productDiv.innerHTML = `
                    <div class="flex items-center space-x-4">
                        <img src="${product.thumbnail || 'https://placehold.co/50x50/E5E7EB/4B5563?text=N/A'}" alt="Product thumbnail" class="w-12 h-12 rounded-xl shadow-md">
                        <div>
                            <p class="font-semibold text-gray-800 text-lg">${product.name}</p>
                            <p class="text-sm text-gray-500">Barcode: ${product.barcode || 'N/A'}</p>
                            <p class="text-xs text-gray-400 bg-gray-100 px-2 py-1 rounded-full inline-block">Stock: ${product.stock}</p>
                        </div>
                    </div>
                    <button data-product-id="${product.id}" class="add-to-cart-btn bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white text-sm font-bold py-3 px-6 rounded-xl shadow-lg transition-all duration-300 transform hover:scale-105 flex items-center space-x-2">
                        <span>‚ûï</span>
                        <span>Add (KSh ${product.price.toFixed(2)})</span>
                    </button>
                `;
                productResultsList.appendChild(productDiv);
            });

            // Attach event listeners to new "Add" buttons
            document.querySelectorAll('.add-to-cart-btn').forEach(button => {
                button.addEventListener('click', async (event) => { // Made async to handle potential stock updates
                    event.preventDefault(); // Prevent any default behavior
                    const productId = button.dataset.productId; // Use button instead of event.target
                    console.log("Button clicked, productId:", productId);
                    await addToCart(productId); // Await addToCart
                    productSearchInput.value = ''; // Clear search bar
                    searchResultsDiv.classList.add('hidden'); // Hide search results
                    productSearchInput.focus(); // Auto-focus search bar
                });
            });
        }

        /**
         * Adds a product to the cart or increments its quantity.
         * @param {string} productIdOrBarcode - The ID or barcode of the product to add.
         */
        async function addToCart(productIdOrBarcode) {
            console.log("addToCart called with:", productIdOrBarcode);
            console.log("Available products:", products.length);
            
            // Check if the parameter is valid
            if (!productIdOrBarcode) {
                showToast('Invalid product identifier provided.', 'error');
                return;
            }

            // First try to find by ID (for manual selection)
            let productToAdd = products.find(p => p.id === productIdOrBarcode);
            console.log("Found by ID:", productToAdd ? productToAdd.name : "Not found");
            
            // If not found by ID, try to find by barcode (for scanned items)
            if (!productToAdd && productIdOrBarcode) {
                productToAdd = products.find(p => p.barcode && p.barcode === productIdOrBarcode);
                console.log("Found by barcode:", productToAdd ? productToAdd.name : "Not found");
            }
            
            if (!productToAdd) {
                console.log("Product not found. Available barcodes:", products.map(p => p.barcode));
                showToast(`Product "${productIdOrBarcode}" not found. Please check the barcode or product name.`, 'error');
                return;
            }

            const existingItemIndex = cart.findIndex(item => item.product.id === productToAdd.id);

            if (existingItemIndex > -1) {
                if (cart[existingItemIndex].quantity < productToAdd.stock) {
                    cart[existingItemIndex].quantity++;
                    showToast(`${productToAdd.name} added to cart!`, 'success');
                } else {
                    showToast(`Not enough stock for ${productToAdd.name}.`, 'warning');
                    return; // Prevent adding if stock is insufficient
                }
            } else {
                if (productToAdd.stock > 0) {
                    cart.push({ product: productToAdd, quantity: 1 });
                    showToast(`${productToAdd.name} added to cart!`, 'success');
                } else {
                    showToast(`${productToAdd.name} is out of stock.`, 'error');
                    return; // Prevent adding if out of stock
                }
            }
            updateCartDisplay();
            calculateTotals();
        }

        /**
         * Updates the quantity of an item in the cart.
         * @param {string} productId - The ID of the product.
         * @param {number} change - The amount to change the quantity by (+1 or -1).
         */
        function updateCartItemQuantity(productId, change) {
            const itemIndex = cart.findIndex(item => item.product.id === productId);
            if (itemIndex > -1) {
                const currentItem = cart[itemIndex];
                const productInDb = products.find(p => p.id === productId);

                // If quantity increases, check stock
                if (change > 0 && currentItem.quantity + change > productInDb.stock) {
                    showToast(`Cannot add more ${currentItem.product.name}. Max stock reached.`, 'warning');
                    return;
                }

                // If quantity goes to 0 or less, require manager approval
                if (currentItem.quantity + change <= 0) {
                    pendingApprovalAction = () => {
                        const removedItemName = currentItem.product.name;
                        cart.splice(itemIndex, 1); // Remove item
                        updateCartDisplay();
                        calculateTotals();
                        showToast(`${removedItemName} removed from cart.`, 'info');
                    };
                    // Set details for logging
                    pendingApprovalActionDetails = { 
                        action: 'Adjust Quantity to Zero/Remove', 
                        itemName: currentItem.product.name 
                    };
                    requestManagerApproval(); // Trigger manager approval
                } else {
                    currentItem.quantity += change;
                    updateCartDisplay();
                    calculateTotals();
                    showToast(`${currentItem.product.name} quantity updated.`, 'info');
                }
            }
        }

        /**
         * Removes an item from the cart. Requires manager approval.
         * @param {string} productId - The ID of the product to remove.
         */
        function removeItemFromCart(productId) {
            const itemToRemove = cart.find(item => item.product.id === productId);
            if (!itemToRemove) return;

            pendingApprovalAction = () => {
                cart = cart.filter(item => item.product.id !== productId);
                updateCartDisplay();
                calculateTotals();
                showToast(`${itemToRemove.product.name} removed from cart.`, 'info');
            };
            // Set details for logging
            pendingApprovalActionDetails = { 
                action: 'Remove Item', 
                itemName: itemToRemove.product.name 
            };
            requestManagerApproval(); // Trigger manager approval
        }

        /**
         * Renders the current items in the cart table.
         */
        function updateCartDisplay() {
            cartItemsTableBody.innerHTML = ''; // Clear current cart display

            if (cart.length === 0) {
                emptyCartMessage.classList.remove('hidden');
            } else {
                emptyCartMessage.classList.add('hidden');
                cart.forEach(item => {
                    const itemVat = calculateItemVat(item.product, item.quantity);
                    const itemSubtotal = calculateItemSubtotal(item.product, item.quantity);

                    const row = document.createElement('tr');
                    row.className = 'bg-white hover:bg-gradient-to-r hover:from-blue-50 hover:to-purple-50 transition-all duration-300';
                    row.innerHTML = `
                        <td class="py-4 px-6 text-gray-800 font-medium flex items-center space-x-3">
                            <img src="${item.product.thumbnail || 'https://placehold.co/40x40/E5E7EB/4B5563?text=N/A'}" alt="Product thumbnail" class="w-10 h-10 rounded-xl shadow-md">
                            <span class="text-lg">${item.product.name}</span>
                        </td>
                        <td class="py-4 px-6 text-gray-700">
                            <div class="flex items-center space-x-2">
                                <button data-product-id="${item.product.id}" data-change="-1" class="qty-btn bg-gradient-to-r from-red-400 to-red-500 hover:from-red-500 hover:to-red-600 text-white w-8 h-8 rounded-full flex items-center justify-center text-sm shadow-lg transition-all duration-300 transform hover:scale-110">-</button>
                                <span class="mx-3 font-bold text-lg bg-gray-100 px-3 py-1 rounded-lg">${item.quantity}</span>
                                <button data-product-id="${item.product.id}" data-change="1" class="qty-btn bg-gradient-to-r from-green-400 to-green-500 hover:from-green-500 hover:to-green-600 text-white w-8 h-8 rounded-full flex items-center justify-center text-sm shadow-lg transition-all duration-300 transform hover:scale-110">+</button>
                                <button data-product-id="${item.product.id}" class="remove-item-btn ml-4 text-red-600 hover:text-red-800 text-2xl transition-colors duration-200">√ó</button>
                            </div>
                        </td>
                        <td class="py-4 px-6 text-gray-700 font-medium">${formatCurrency(item.product.price)}</td>
                        <td class="py-4 px-6 text-gray-700 font-medium">${formatCurrency(itemVat)}</td>
                        <td class="py-4 px-6 text-gray-900 font-bold text-lg">${formatCurrency(itemSubtotal)}</td>
                    `;
                    cartItemsTableBody.appendChild(row);
                });

                // Attach event listeners for quantity buttons and remove buttons
                document.querySelectorAll('.qty-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const productId = event.target.dataset.productId;
                        const change = parseInt(event.target.dataset.change);
                        updateCartItemQuantity(productId, change);
                    });
                });

                document.querySelectorAll('.remove-item-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const productId = event.target.dataset.productId;
                        removeItemFromCart(productId);
                    });
                });
            }
        }

        /**
         * Generates the HTML content for the receipt.
         * @returns {string} HTML string of the receipt.
         */
        async function generateReceiptContent() { 
            const now = new Date();
            // Generate date-based sequential invoice number: TXN-YYYYMMDD-001
            const transactionId = await getNextInvoiceNumber();
            // Note: Counter increment is now handled atomically in getNextInvoiceNumber()

            const storeName = "Prince Alex Store";
            const storeAddress = "123 Market Street, Nairobi, Kenya";
            const storeEmail = "info@princealexstore.com";
            const cashierName = currentCashier ? currentCashier.name : "Unknown"; // Use currentCashier
            const tillNumber = "001"; 
            const serialNumber = "SN-POS-2024-001"; // Placeholder
            const cuInvoiceNumber = "CUINV-2024-001"; // Placeholder
            const cuDate = now.toLocaleDateString('en-GB'); // Placeholder date format
            const printedDate = now.toLocaleString();

            let itemsTableRows = '';
            let grossSaleValue = 0; // Sum of price * qty (before VAT)

            // Prepare cart items for saving (simplified structure)
            const salesCartItems = cart.map(item => ({
                id: item.product.id,
                name: item.product.name,
                barcode: item.product.barcode,
                quantity: item.quantity,
                price: item.product.price,
                vatRate: item.product.vatRate,
                amount: calculateItemSubtotal(item.product, item.quantity) // Amount includes VAT
            }));


            cart.forEach(item => {
                const itemNetPrice = item.product.price * item.quantity;
                const { vatAmount, total: itemAmountInclVat } = calculateVAT(itemNetPrice, vatRate);

                grossSaleValue += itemNetPrice; // Sum of net prices

                itemsTableRows += `
                    <tr>
                        <td class="py-1 px-2 text-left">${item.product.name}</td>
                        <td class="py-1 px-2 text-center">${item.product.barcode || 'N/A'}</td>
                        <td class="py-1 px-2 text-center">${item.quantity}</td>
                        <td class="py-1 px-2 text-right">${item.product.price.toFixed(2)}</td>
                        <td class="py-1 px-2 text-right">${itemAmountInclVat.toFixed(2)}</td>
                    </tr>
                `;
            });

            // These values are already updated by calculateTotals() based on the new logic
            const totalBeforeVat = parseFloat(totalBeforeVatSpan.textContent.replace('KSh ', ''));
            const vatAmount = parseFloat(vatAmountSpan.textContent.replace('KSh ', ''));
            const grandTotal = parseFloat(grandTotalSpan.textContent.replace('KSh ', ''));
            let cashReceived = parseFloat(cashReceivedInput.value) || 0;
            let balance = parseFloat(balanceAmountSpan.textContent.replace('KSh ', ''));

            // Adjust received and balance for digital payments on receipt
            let paymentDetails = `Cash: ${formatCurrency(cashReceived)}`;
            let balanceDisplay = formatCurrency(balance);
            if (selectedPaymentMethod === 'Mpesa' || selectedPaymentMethod === 'Card') {
                cashReceived = grandTotal;
                balance = 0;
                balanceDisplay = formatCurrency(0); // Show 0 change for digital
                paymentDetails = `${selectedPaymentMethod}: ${formatCurrency(grandTotal)}`;
            }

            const totalSavings = 0.00; // Placeholder for total savings

            // Construct the sale object to save
            const saleData = {
                invoiceNo: transactionId,
                timestamp: now.toISOString(), // Use ISO string for Firestore
                cashierName: cashierName,
                tillNumber: tillNumber,
                cartItems: salesCartItems, // Store the simplified cart items
                paymentMethod: selectedPaymentMethod,
                grossSaleValue: grossSaleValue, // This is the Net Amount before VAT
                totalBeforeVat: totalBeforeVat, // This should be the same as grossSaleValue now
                vatAmount: vatAmount,
                grandTotal: grandTotal,
                receivedAmount: cashReceived,
                balancePaid: balance,
                totalSavings: totalSavings,
                serialNo: serialNumber,
                cuInvoiceNo: cuInvoiceNumber,
                cuDate: cuDate,
                printedDate: printedDate
            };
            
            // Save the completed sale to Firestore
            await saveSaleToFirestore(saleData); 
            // Update stock in Firestore
            await updateStockAfterSale(saleData.cartItems);

            return `
                <div class="text-center mb-4">
                    <img src="https://placehold.co/80x80/000/fff?text=STORE+LOGO" alt="Store Logo" class="mx-auto mb-2 rounded-full">
                    <h2 class="text-2xl font-bold text-gray-900">${storeName}</h2>
                    <p class="text-sm text-gray-600">${storeAddress}</p>
                    <p class="text-sm text-gray-600">Email: ${storeEmail}</p>
                </div>
                <hr>
                <h3 class="text-xl font-bold text-center my-4">TAX INVOICE</h3>
                <hr>
                <div class="my-4 text-gray-700">
                    <div class="flex justify-between mb-1"><span>Invoice No:</span><span>${transactionId}</span></div>
                    <div class="flex justify-between mb-1"><span>Date:</span><span>${now.toLocaleDateString()}</span></div>
                    <div class="flex justify-between mb-1"><span>Time:</span><span>${now.toLocaleTimeString()}</span></div>
                    <div class="flex justify-between mb-1"><span>Cashier:</span><span>${cashierName}</span></div>
                    <div class="flex justify-between mb-1"><span>Till No:</span><span>${tillNumber}</span></div>
                </div>
                <hr>
                <div class="my-4">
                    <h3 class="font-bold text-lg mb-2">Products Bought:</h3>
                    <table class="min-w-full text-sm">
                        <thead>
                            <tr class="border-b border-gray-300">
                                <th class="py-1 px-2 text-left">Item</th>
                                <th class="py-1 px-2 text-center">Barcode</th>
                                <th class="py-1 px-2 text-center">Qty</th>
                                <th class="py-1 px-2 text-right">Unit Price</th>
                                <th class="py-1 px-2 text-right">Amount (Incl. VAT)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsTableRows}
                        </tbody>
                    </table>
                </div>
                <hr>
                <div class="my-4 text-gray-800">
                    <div class="flex justify-between mb-1">
                        <span>Net Amount (Before VAT):</span>
                        <span>${formatCurrency(totalBeforeVat)}</span>
                    </div>
                    <div class="flex justify-between mb-1">
                        <span>VAT (${vatRate * 100}%):</span>
                        <span>${formatCurrency(vatAmount)}</span>
                    </div>
                    <div class="flex justify-between text-lg font-bold mt-2">
                        <span>Grand Total:</span>
                        <span>${formatCurrency(grandTotal)}</span>
                    </div>
                    <div class="flex justify-between mb-1 mt-2">
                        <span>Payment:</span>
                        <span>${paymentDetails}</span>
                    </div>
                    <div class="flex justify-between mb-1">
                        <span>Change:</span>
                        <span>${balanceDisplay}</span>
                    </div>
                    <div class="flex justify-between text-lg font-bold mt-2">
                        <span>Total Savings:</span>
                        <span>${formatCurrency(totalSavings)}</span>
                    </div>
                </div>
                <hr>
                <div class="my-4 text-gray-800">
                    <h3 class="font-bold text-lg mb-2">Tax Summary:</h3>
                    <div class="flex justify-between mb-1">
                        <span>VAT (${vatRate * 100}% of ${formatCurrency(totalBeforeVat)}):</span>
                        <span>${formatCurrency(vatAmount)}</span>
                    </div>
                </div>
                <hr>
                <div class="text-center mt-4">
                    <p class="font-bold italic text-sm text-gray-700">Thank you for shopping with us!</p>
                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=${encodeURIComponent(`Transaction ID: ${transactionId}, Total: ${grandTotal}`)}" alt="QR Code for Verification" class="mx-auto mb-2">
                    <p class="text-sm text-gray-600">Scan for Verification</p>
                    <div class="flex justify-between text-sm text-gray-600 mb-1 mt-2">
                        <span>Serial No:</span>
                        <span>${serialNumber}</span>
                    </div>
                    <div class="flex justify-between text-sm text-gray-600 mb-1">
                        <span>CU Invoice No:</span>
                        <span>${cuInvoiceNumber}</span>
                    </div>
                    <div class="flex justify-between text-sm text-gray-600 mb-1">
                        <span>CU Date:</span>
                        <span>${cuDate}</span>
                    </div>
                    <p class="text-sm text-gray-600 mt-2">Printed Date: ${printedDate}</p>
                    <p class="text-sm text-gray-600 mt-4 border-t border-dashed pt-2">
                        <span class="font-bold">Return Policy:</span> Items can be returned within 14 days with original receipt.
                    </p>
                </div>
            `;
        }

        /**
         * Downloads the receipt as a PDF or HTML file.
         */
        function downloadReceipt() {
            // Check if receipt modal has content
            if (!receiptContentBody.innerHTML || receiptContentBody.innerHTML.trim() === '') {
                showToast('No receipt to download. Please complete a sale first.', 'warning');
                return;
            }
            
            try {
                const receiptContent = receiptContentBody.innerHTML;
                const now = new Date();
                const timestamp = now.toISOString().slice(0, 19).replace(/[:-]/g, '');
                const filename = `receipt_${timestamp}.html`;
                
                // Create a blob with the receipt content
                const blob = new Blob([`
                    <!DOCTYPE html>
                    <html lang="en">
                    <head>
                        <meta charset="UTF-8">
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <title>Receipt - Prince Alex Store</title>
                        <style>
                            body { 
                                font-family: 'Inter', sans-serif; 
                                margin: 0; 
                                padding: 20px; 
                                background: white;
                                color: #000;
                            }
                            .receipt-content { 
                                max-width: 400px; 
                                margin: 0 auto; 
                                background: white;
                                padding: 20px;
                                border: 1px solid #ddd;
                            }
                            table { width: 100%; border-collapse: collapse; }
                            th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
                            th { background-color: #f5f5f5; font-weight: bold; }
                            hr { border: none; border-top: 1px dashed #ccc; margin: 10px 0; }
                            .text-center { text-align: center; }
                            .text-right { text-align: right; }
                            .font-bold { font-weight: bold; }
                            .text-lg { font-size: 1.125rem; }
                            .text-xl { font-size: 1.25rem; }
                            .text-2xl { font-size: 1.5rem; }
                            img { max-width: 100px; height: auto; }
                        </style>
                    </head>
                    <body>
                        <div class="receipt-content">
                            ${receiptContent}
                        </div>
                    </body>
                    </html>
                `], { type: 'text/html' });
                
                // Create download link
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showToast('Receipt downloaded successfully!', 'success');
                
            } catch (error) {
                console.error('Download error:', error);
                showToast('Error downloading receipt. Please try again.', 'error');
            }
        }

        /**
         * Displays the receipt modal with generated content.
         */
        async function showReceipt() { 
            receiptContentBody.innerHTML = await generateReceiptContent(); 
            toggleModal(receiptModal, true); // Show the modal with animation
        }

        /**
         * Hides the receipt modal.
         */
        function hideReceipt() {
            toggleModal(receiptModal, false); // Hide the modal with animation
        }

        /**
         * Handles the printing of the receipt.
         */
        function printReceipt() {
            // Check if receipt modal has content
            if (!receiptContentBody.innerHTML || receiptContentBody.innerHTML.trim() === '') {
                showToast('No receipt to print. Please complete a sale first.', 'warning');
                return;
            }
            
            // Show receipt modal first if not already visible
            if (receiptModal.style.display === 'none' || receiptModal.classList.contains('hidden')) {
                showReceipt(); 
            }
            
            // Wait for modal to be visible, then print
            setTimeout(() => {
                try {
                const printContents = receiptContentBody.innerHTML;

                // Create a new window for printing
                    const printWindow = window.open('', '_blank', 'width=600,height=800');
                    
                    if (!printWindow) {
                        showToast('Please allow popups to print receipts.', 'error');
                        hideReceipt();
                        return;
                    }
                    
                    printWindow.document.write('<html><head><title>Receipt - Prince Alex Store</title>');
                    printWindow.document.write('<meta charset="UTF-8">');
                    printWindow.document.write('<meta name="viewport" content="width=device-width, initial-scale=1.0">');
                    
                    // Include fonts and styles for printing
                printWindow.document.write('<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">');
                printWindow.document.write('<style>');
                printWindow.document.write(`
                        * { box-sizing: border-box; }
                        body { 
                            font-family: 'Inter', sans-serif; 
                            margin: 0; 
                            padding: 0.5rem; 
                            background: white;
                            color: #000;
                        }
                        .receipt-content { 
                            width: 100%; 
                            max-width: 400px; 
                            margin: 0 auto; 
                            padding: 0;
                            background: white;
                        }
                        .receipt-content hr { 
                            border: none;
                            border-top: 1px dashed #333; 
                            margin: 0.5rem 0; 
                        }
                    .text-center { text-align: center; }
                    .mb-4 { margin-bottom: 1rem; }
                    .text-2xl { font-size: 1.5rem; }
                    .font-bold { font-weight: 700; }
                        .text-gray-900 { color: #000; }
                    .text-sm { font-size: 0.875rem; }
                        .text-gray-600 { color: #333; }
                    .my-4 { margin-top: 1rem; margin-bottom: 1rem; }
                        .text-gray-700 { color: #333; }
                        .text-gray-800 { color: #000; }
                    .font-semibold { font-weight: 600; }
                    .text-lg { font-size: 1.125rem; }
                    .flex { display: flex; }
                    .justify-between { justify-content: space-between; }
                    .text-xs { font-size: 0.75rem; }
                    .ml-4 { margin-left: 1rem; }
                    .mx-auto { margin-left: auto; margin-right: auto; }
                        img { 
                            display: block; 
                            max-width: 100px;
                            height: auto;
                        }
                        table { 
                            width: 100%; 
                            border-collapse: collapse; 
                            margin: 0.5rem 0;
                        }
                        th, td { 
                            padding: 0.25rem 0.5rem; 
                            border-bottom: 1px solid #ddd; 
                            font-size: 0.875rem;
                        }
                        th { 
                            text-align: left; 
                            font-weight: 600;
                            background: #f5f5f5;
                        }
                    td { text-align: right; }
                    td:first-child { text-align: left; }
                        
                        /* Print-specific styles */
                        @media print {
                            body { margin: 0; padding: 0; }
                            .receipt-content { 
                                max-width: none; 
                                width: 100%; 
                                margin: 0; 
                                padding: 0.25rem;
                            }
                            .receipt-content hr { margin: 0.25rem 0; }
                            table { font-size: 0.75rem; }
                            th, td { padding: 0.125rem 0.25rem; }
                        }
                `);
                printWindow.document.write('</style></head><body>');
                printWindow.document.write('<div class="receipt-content">');
                printWindow.document.write(printContents);
                printWindow.document.write('</div></body></html>');
                printWindow.document.close();
                    
                    // Focus and print
                printWindow.focus();
                    
                    // Wait for content to load, then print
                    setTimeout(() => {
                printWindow.print();
                        
                        // Close window after printing (with delay for print dialog)
                        setTimeout(() => {
                printWindow.close();
                        }, 1000);
                    }, 100);
                    
                hideReceipt(); // Hide modal after print command
                    showToast('Receipt sent to printer!', 'success');
                    
                } catch (error) {
                    console.error('Print error:', error);
                    showToast('Error printing receipt. Please try again.', 'error');
                    hideReceipt();
                }
            }, 100); // Small delay to ensure modal is visible
        }

        /**
         * Triggers the manager approval modal for restricted actions.
         */
        function requestManagerApproval() {
            managerCodeInput.value = ""; // Clear input field
            approvalError.classList.add("hidden"); // Hide previous error
            toggleModal(managerApprovalModal, true); // Show the modal with animation
            managerCodeInput.focus(); // Focus on input for scanner/manual entry
        }

        /**
         * Handles the manager approval process.
         * This function replaces the previous validateManagerApproval().
         */
        async function approveAction() {
            const code = managerCodeInput.value.trim();
            approvalError.classList.add("hidden"); // Hide error on new attempt

            try {
                const q = query(usersCol, where("role", "in", ["manager", "admin"]));
                const snapshot = await getDocs(q);

                let approvedUser = null;
                snapshot.forEach(docSnap => {
                    const user = docSnap.data();
                    if (user.code === code || user.cardId === code) {
                        approvedUser = { id: docSnap.id, ...user };
                    }
                });

                if (approvedUser) {
                    toggleModal(managerApprovalModal, false); // Hide approval modal with animation
                    showToast(`Approved by ${approvedUser.name}`, "success");

                    // Execute the pending action
                    if (pendingApprovalAction) {
                        pendingApprovalAction();
                    }

                    // Log the approval
                    await addDoc(managerLogsCol, {
                        manager: approvedUser.name,
                        action: pendingApprovalActionDetails.action, // Use the stored action details
                        item: pendingApprovalActionDetails.itemName,   // Use the stored item name
                        cashier: currentCashier ? currentCashier.name : "Unknown", // Current cashier
                        timestamp: serverTimestamp() // Use Firestore server timestamp
                    });

                } else {
                    approvalError.classList.remove("hidden"); // Show invalid code error
                    showToast("Invalid Manager Code", "error");
                    managerCodeInput.value = ''; // Clear input
                    managerCodeInput.focus(); // Re-focus
                }
            } catch (error) {
                console.error("Error during manager approval:", error);
                showToast("An error occurred during approval. Please try again.", "error");
            }
        }


        /**
         * Fetches cashier data from users collection by cardId or code.
         */
        async function fetchCashierData(cashierCode) {
                const q = query(usersCol, where("role", "==", "cashier"));
                const snapshot = await getDocs(q);

                let found = null;
                snapshot.forEach(docSnap => {
                    const user = docSnap.data();
                if (user.code === cashierCode || user.cardId === cashierCode) {
                        found = { id: docSnap.id, ...user };
                    }
                });

            if (found) {
                return found;
            } else {
                throw new Error("Cashier not found in users collection");
            }
        }

        /**
         * Logs a cashier in.
         */
        async function cashierLogin() {
            const code = cashierCodeInput.value.trim();
            loginErrorMsg.classList.add("hidden"); // Hide previous error

            try {
                const found = await fetchCashierData(code);

                if (found) {
                    currentCashier = found;
                    // For persistence, we'll use localStorage
                    localStorage.setItem("currentCashier", JSON.stringify(found)); 
                    cashierLoginDiv.classList.add("hidden"); // Hide login screen
                    mainPosContent.classList.remove("hidden"); // Show main POS content
                    cashierNameDisplay.textContent = currentCashier.name; // Update display
                    
                    // Show current date and invoice format
                    const today = new Date();
                    const dateStr = today.toISOString().slice(0, 10).replace(/-/g, '');
                    const sampleInvoice = `TXN-${dateStr}-001`;
                    showToast(`Welcome, ${currentCashier.name}! Today's invoices: ${sampleInvoice}`, "success");
                    
                    // Update scanner status after login
                    updateScannerStatus();
                    updateScannerModeDisplay();
                    
                    // Start invoice counter monitoring
                    invoiceCounterUnsubscribe = startInvoiceCounterMonitoring();
                    
                    resetInactivityTimer(); // Start the inactivity timer

                    // Setup real-time listener for products after successful login
                    productsSnapshotUnsubscribe = onSnapshot(productsCol, (snapshot) => {
                        products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        console.log("Products updated in real-time:", products);
                        console.log("Sample product structure:", products[0]); // Log first product to see structure
                        updateCartDisplay(); // Re-render cart if products change (e.g., stock update)
                        calculateTotals();   // Re-calculate totals
                    }, (error) => {
                        console.error("Error listening to products collection:", error);
                        showToast("Failed to get real-time product updates. Please check console.", "error");
                    });
                } else {
                    loginErrorMsg.classList.remove("hidden"); // Show error
                    showToast("Invalid PIN or Card ID.", "error"); // Use cross emoji
                    cashierCodeInput.value = '';
                    cashierCodeInput.focus();
                }
            } catch (error) {
                console.error("Error during cashier login:", error);
                showToast("Login failed. Please try again later.", "error");
            }
        }

        /**
         * Handles cashier logout.
         */
        function cashierLogout() {
            currentCashier = null;
            localStorage.removeItem("currentCashier");
            cashierNameDisplay.textContent = "Logged Out";
            showToast("Logged out due to inactivity.", "info"); // Inform user about auto-logout
            clearTimeout(inactivityTimer); // Clear the timer
            // Reset POS state
            resetPOS(); 
            // Hide main POS content on logout
            mainPosContent.classList.add("hidden");
            // Show login screen
            cashierLoginDiv.classList.remove("hidden");
            cashierCodeInput.value = '';
            cashierCodeInput.focus();
            // Important: Stop product snapshot listener on logout to prevent issues
            if (productsSnapshotUnsubscribe) {
                productsSnapshotUnsubscribe();
                productsSnapshotUnsubscribe = null;
            }
            
            // Stop invoice counter monitoring
            if (invoiceCounterUnsubscribe) {
                invoiceCounterUnsubscribe();
                invoiceCounterUnsubscribe = null;
            }
        }

        // Store the unsubscribe function for the product snapshot listener
        let productsSnapshotUnsubscribe = null;

        /**
         * Saves a completed sale transaction to Firestore.
         * @param {object} saleData - The completed sale object.
         */
        async function saveSaleToFirestore(saleData) {
            try {
                // Use the name from the currentCashier object
                saleData.cashierName = currentCashier ? currentCashier.name : "Unknown"; 
                await addDoc(salesCol, saleData);
                console.log("Sale saved to Firestore:", saleData);
            } catch (error) {
                console.error("Error saving sale to Firestore:", error);
                showToast("Failed to save sale. Please check console.", "error");
            }
        }

        /**
         * Updates stock in Firestore after a sale.
         * @param {Array<object>} cartItems - Items in the completed sale.
         */
        async function updateStockAfterSale(cartItems) {
            for (let item of cartItems) {
                const productRef = doc(db, "products", item.id);
                const productInDb = products.find(p => p.id === item.id); // Find the current product in our local 'products' array
                if (productInDb) {
                    const newStock = productInDb.stock - item.quantity;
                    await updateDoc(productRef, {
                        stock: newStock >= 0 ? newStock : 0 // Ensure stock doesn't go negative in DB
                    });
                    // Also update the local 'products' array to reflect new stock
                    productInDb.stock = newStock >= 0 ? newStock : 0;
                }
            }
            console.log("Stock updated in Firestore.");
        }

        /**
         * Resets the POS system to a fresh state after a completed sale.
         */
        function resetPOS() {
            cart = [];
            selectedPaymentMethod = null;
            paymentConfirmed = false; // Reset payment confirmation
            cashReceivedInput.value = '';
            balanceAmountSpan.textContent = formatCurrency(0);
            document.querySelectorAll('.payment-btn').forEach(btn => {
                btn.classList.remove('ring-2', 'ring-offset-2', 'ring-blue-500');
            });
            cashPaymentSection.classList.add('hidden');
            digitalPaymentStatusDiv.classList.add('hidden'); // Hide digital payment status
            digitalPaymentMessage.textContent = '';
            digitalPaymentDetails.textContent = '';
            
            // Reset Complete Sale button to original state
            completeSaleBtn.disabled = false;
            completeSaleBtn.innerHTML = `
                <span class="text-2xl">‚úÖ</span>
                <span>Complete Sale</span>
            `;
            
            updateCartDisplay();
            calculateTotals();
        }

        /**
         * Function to handle "Cancel Sale" action, clears the current cart.
         */
        function cancelCurrentSale() {
            cart = []; // Clear the cart
            resetPOS(); // Reset the POS state
            showToast("Current sale cancelled.", "info");
        }

        /**
         * Function to open refund modal and start refund request.
         */
        function openRefundRequest() {
            // Clear previous data
            refundInvoiceNoInput.value = '';
            refundSaleDetails.classList.add('hidden');
            refundError.classList.add('hidden');
            refundSuccess.classList.add('hidden');
            
            // Reset action buttons visibility
            const refundActionButtons = document.getElementById('refundActionButtons');
            refundActionButtons.style.display = 'flex';
            
            // Show refund modal
            toggleModal(refundModal, true);
            refundInvoiceNoInput.focus();
        }

        /**
         * Function to search for a sale by invoice number.
         */
        async function searchRefundSale() {
            const invoiceNo = refundInvoiceNoInput.value.trim();
            
            if (!invoiceNo) {
                refundError.textContent = 'Please enter an invoice number.';
                refundError.classList.remove('hidden');
                return;
            }

            try {
                // Search for sale in Firestore
                const q = query(salesCol, where("invoiceNo", "==", invoiceNo));
                const snapshot = await getDocs(q);
                
                if (snapshot.empty) {
                    refundError.textContent = `No sale found with invoice number: ${invoiceNo}`;
                    refundError.classList.remove('hidden');
                    refundSaleDetails.classList.add('hidden');
                    return;
                }

                // Get the sale data
                const saleDoc = snapshot.docs[0];
                const saleData = { id: saleDoc.id, ...saleDoc.data() };
                
                // Check if refund request already exists for this invoice
                const refundQuery = query(refundRequestsCol, where("invoiceNo", "==", invoiceNo));
                const refundSnapshot = await getDocs(refundQuery);
                
                let existingRefundRequest = null;
                if (!refundSnapshot.empty) {
                    existingRefundRequest = { id: refundSnapshot.docs[0].id, ...refundSnapshot.docs[0].data() };
                }
                
                // Display sale details with refund status
                displayRefundSaleDetails(saleData, existingRefundRequest);
                
                // Hide error and show details
                refundError.classList.add('hidden');
                refundSaleDetails.classList.remove('hidden');
                
            } catch (error) {
                console.error("Error searching for sale:", error);
                refundError.textContent = 'Error searching for sale. Please try again.';
                refundError.classList.remove('hidden');
            }
        }

        /**
         * Function to display sale details in the refund modal.
         */
        function displayRefundSaleDetails(saleData, existingRefundRequest = null) {
            const saleDate = new Date(saleData.timestamp).toLocaleString();
            
            // Determine refund status and styling
            let refundStatusHtml = '';
            let refundStatusClass = '';
            let refundStatusIcon = '';
            let refundStatusText = '';
            
            if (existingRefundRequest) {
                switch (existingRefundRequest.status) {
                    case 'pending':
                        refundStatusClass = 'bg-yellow-100 text-yellow-800 border-yellow-200';
                        refundStatusIcon = '‚è≥';
                        refundStatusText = 'Pending Review';
                        break;
                    case 'approved':
                        refundStatusClass = 'bg-green-100 text-green-800 border-green-200';
                        refundStatusIcon = '‚úÖ';
                        refundStatusText = 'Approved';
                        break;
                    case 'rejected':
                        refundStatusClass = 'bg-red-100 text-red-800 border-red-200';
                        refundStatusIcon = '‚ùå';
                        refundStatusText = 'Rejected';
                        break;
                }
                
                const requestDate = existingRefundRequest.requestedAt ? 
                    new Date(existingRefundRequest.requestedAt.seconds * 1000).toLocaleString() : 'N/A';
                
                refundStatusHtml = `
                    <div class="mt-4 bg-gradient-to-r from-blue-50 to-purple-50 p-4 rounded-xl border border-blue-200">
                        <div class="flex items-center space-x-3 mb-2">
                            <span class="text-2xl">üìã</span>
                            <div>
                                <h4 class="font-semibold text-gray-800">Existing Refund Request</h4>
                                <p class="text-sm text-gray-600">Request submitted on ${requestDate}</p>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <span class="px-3 py-1 rounded-full text-sm font-medium ${refundStatusClass}">
                                    ${refundStatusIcon} ${refundStatusText}
                                </span>
                                <span class="text-sm text-gray-600">Requested by: ${existingRefundRequest.requestedBy}</span>
                            </div>
                            ${existingRefundRequest.status === 'pending' ? 
                                '<span class="text-sm text-blue-600 font-medium">‚è∞ Under Review</span>' : 
                                existingRefundRequest.status === 'approved' ? 
                                '<span class="text-sm text-green-600 font-medium">‚úÖ Refund Approved</span>' :
                                '<span class="text-sm text-red-600 font-medium">‚ùå Refund Rejected</span>'
                            }
                        </div>
                    </div>
                `;
            }
            
            refundSaleInfo.innerHTML = `
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-white p-3 rounded-lg shadow-sm">
                        <span class="text-sm text-gray-600">Invoice No:</span>
                        <p class="font-semibold text-gray-800">${saleData.invoiceNo}</p>
                    </div>
                    <div class="bg-white p-3 rounded-lg shadow-sm">
                        <span class="text-sm text-gray-600">Date:</span>
                        <p class="font-semibold text-gray-800">${saleDate}</p>
                    </div>
                    <div class="bg-white p-3 rounded-lg shadow-sm">
                        <span class="text-sm text-gray-600">Cashier:</span>
                        <p class="font-semibold text-gray-800">${saleData.cashierName}</p>
                    </div>
                    <div class="bg-white p-3 rounded-lg shadow-sm">
                        <span class="text-sm text-gray-600">Payment Method:</span>
                        <p class="font-semibold text-gray-800">${saleData.paymentMethod}</p>
                    </div>
                    <div class="bg-white p-3 rounded-lg shadow-sm">
                        <span class="text-sm text-gray-600">Total Amount:</span>
                        <p class="font-semibold text-gray-800">${formatCurrency(saleData.grandTotal)}</p>
                    </div>
                    <div class="bg-white p-3 rounded-lg shadow-sm">
                        <span class="text-sm text-gray-600">Items Count:</span>
                        <p class="font-semibold text-gray-800">${saleData.cartItems.length} items</p>
                    </div>
                </div>
                
                <div class="mt-4">
                    <h4 class="font-semibold text-gray-700 mb-2">Items in Sale:</h4>
                    <div class="bg-white p-3 rounded-lg shadow-sm max-h-40 overflow-y-auto">
                        ${saleData.cartItems.map(item => `
                            <div class="flex justify-between items-center py-1 border-b border-gray-100 last:border-b-0">
                                <span class="text-sm text-gray-700">${item.name} (${item.barcode || 'N/A'})</span>
                                <span class="text-sm font-semibold text-gray-800">Qty: ${item.quantity} - ${formatCurrency(item.amount)}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                ${refundStatusHtml}
            `;
            
            // Show/hide action buttons based on existing refund status
            const refundActionButtons = document.getElementById('refundActionButtons');
            if (existingRefundRequest) {
                // Hide action buttons if refund request already exists
                refundActionButtons.style.display = 'none';
            } else {
                // Show action buttons if no existing refund request
                refundActionButtons.style.display = 'flex';
            }
        }

        /**
         * Function to submit refund request to admin for approval.
         */
        async function requestRefundApproval() {
            const invoiceNo = refundInvoiceNoInput.value.trim();
            
            try {
                // First check if refund request already exists
                const existingRefundQuery = query(refundRequestsCol, where("invoiceNo", "==", invoiceNo));
                const existingRefundSnapshot = await getDocs(existingRefundQuery);
                
                if (!existingRefundSnapshot.empty) {
                    const existingRequest = existingRefundSnapshot.docs[0].data();
                    let message = '';
                    
                    switch (existingRequest.status) {
                        case 'pending':
                            message = `A refund request for invoice ${invoiceNo} is already pending review. Please wait for manager approval.`;
                            break;
                        case 'approved':
                            message = `A refund request for invoice ${invoiceNo} has already been approved. No duplicate request needed.`;
                            break;
                        case 'rejected':
                            message = `A refund request for invoice ${invoiceNo} was previously rejected. Please contact management for assistance.`;
                            break;
                    }
                    
                    refundError.textContent = message;
                    refundError.classList.remove('hidden');
                    refundSuccess.classList.add('hidden');
                    return;
                }
                
                // Get the sale data again to include in the refund request
                const q = query(salesCol, where("invoiceNo", "==", invoiceNo));
                const snapshot = await getDocs(q);
                
                if (snapshot.empty) {
                    refundError.textContent = `Sale not found for invoice: ${invoiceNo}`;
                    refundError.classList.remove('hidden');
                    return;
                }

                const saleDoc = snapshot.docs[0];
                const saleData = { id: saleDoc.id, ...saleDoc.data() };
                
                // Create refund request document
                const refundRequestData = {
                    invoiceNo: invoiceNo,
                    saleId: saleDoc.id,
                    saleData: saleData,
                    requestedBy: currentCashier ? currentCashier.name : "Unknown",
                    requestedAt: serverTimestamp(),
                    status: "pending", // pending, approved, rejected
                    refundAmount: saleData.grandTotal,
                    reason: "Customer request", // You could add a reason field to the modal
                    processedBy: null, // Will be filled when manager processes it
                    processedAt: null, // Will be filled when manager processes it
                    notes: "" // Additional notes from manager
                };
                
                // Save refund request to Firestore
                await addDoc(refundRequestsCol, refundRequestData);
                
                // Show success message to cashier
                refundSuccess.textContent = `Refund request submitted successfully! Invoice: ${invoiceNo}. This will be processed within 24 hours.`;
                refundSuccess.classList.remove('hidden');
                refundError.classList.add('hidden');
                
                // Hide sale details
                refundSaleDetails.classList.add('hidden');
                
                // Show toast notification
                showToast(`Refund request submitted for ${invoiceNo}. Processing time: 24 hours.`, 'success');
                
                // Close modal after 3 seconds
                setTimeout(() => {
                    toggleModal(refundModal, false);
                    // Reset form
                    refundInvoiceNoInput.value = '';
                    refundSaleDetails.classList.add('hidden');
                    refundError.classList.add('hidden');
                    refundSuccess.classList.add('hidden');
                }, 3000);
                
            } catch (error) {
                console.error("Error submitting refund request:", error);
                refundError.textContent = 'Error submitting refund request. Please try again.';
                refundError.classList.remove('hidden');
                refundSuccess.classList.add('hidden');
            }
        }

        /**
         * Function to process the approved refund.
         */
        async function processRefundApproval(invoiceNo) {
            try {
                // Here you would typically:
                // 1. Update stock levels (add back the quantities)
                // 2. Create a refund record
                // 3. Update financial records
                // 4. Send notification to admin system
                
                showToast(`Refund for invoice ${invoiceNo} has been processed successfully.`, 'success');
                
                // Log the refund in manager logs
                await addDoc(managerLogsCol, {
                    manager: "Approved Manager", // This would be the actual manager name
                    action: 'Process Refund',
                    item: `Invoice: ${invoiceNo}`,
                    cashier: currentCashier ? currentCashier.name : "Unknown",
                    timestamp: serverTimestamp(),
                    refundAmount: "TBD", // You'd calculate this from the sale data
                    status: "Approved"
                });
                
                // Reset the refund modal
                refundInvoiceNoInput.value = '';
                refundSaleDetails.classList.add('hidden');
                refundError.classList.add('hidden');
                refundSuccess.classList.add('hidden');
                
            } catch (error) {
                console.error("Error processing refund:", error);
                showToast("Error processing refund. Please try again.", "error");
            }
        }


        // --- Product Barcode Scanner Functions ---
        // Keeping these functions as they are used, but their related DOM elements in manager approval modal HTML are removed.
        function startScanner() {
            // If scanner already exists or is in a scanning state, don't restart
            if (html5QrcodeScanner && html5QrcodeScanner.isScanning) {
                showToast("Product scanner is already running.", "info");
                return;
            }

            productScannerMessage.classList.remove('hidden'); // Show initializing message
            const qrCodeReaderElement = document.getElementById("reader");
            stopScannerBtn.classList.remove('hidden'); // Show the stop button

            // Define what happens when a barcode is successfully scanned
            async function onScanSuccess(decodedText, decodedResult) {
                console.log("Scanner decoded:", decodedText);
                // Debounce logic: only process if different from last scanned or if enough time has passed
                if (!lastScannedCode || lastScannedCode !== decodedText) {
                    lastScannedCode = decodedText;
                    playBeep(); // Play beep sound on success
                    console.log("Calling addToCart with scanned barcode:", decodedText);
                    await addToCart(decodedText); // Call your function to handle the product
                    productSearchInput.value = decodedText; // Populate search input with scanned code
                    // Set a timeout to clear the lastScannedCode after a debounce period (e.g., 800ms)
                    setTimeout(() => { lastScannedCode = null; }, 800); 
                }
                // Do NOT stop scanner here; allow continuous scanning
            }

            // Define what happens when scan error occurs
            function onScanError(errorMessage) {
                // console.warn(`Scan error: ${errorMessage}`); // Log errors for debugging, but don't show to user constantly
            }

            // Define the scanner
            html5QrcodeScanner = new Html5Qrcode("reader");
            // Optimized config: Higher FPS, smaller QR box, disableFlip
            const config = { 
                fps: 30, // Increased FPS for smoother scanning
                qrbox: { width: 200, height: 200 }, // Reduced QR box size for faster decode
                disableFlip: true // Can improve performance on some devices
            };

            html5QrcodeScanner.start(
                { facingMode: "environment" }, // Use back camera for better performance
                config,
                onScanSuccess,
                onScanError // Pass error handler
            ).then(() => {
                productScannerMessage.classList.add('hidden'); // Hide message once camera starts
            }).catch(err => {
                console.error("Error starting scanner:", err);
                showToast("Error starting scanner. Please ensure camera access is granted.", "error");
                stopScannerBtn.classList.add('hidden'); // Hide stop button if scanner fails to start
                productScannerMessage.classList.add('hidden'); // Hide message on error
            });
        }

        function stopScanner() {
            if (html5QrcodeScanner && html5QrcodeScanner.isScanning) { // Check if scanner is active
                html5QrcodeScanner.stop().then(() => {
                    html5QrcodeScanner.clear();
                    document.getElementById("reader").innerHTML = ''; // Clear scanner view
                    html5QrcodeScanner = null; // Reset scanner instance
                    stopScannerBtn.classList.add('hidden'); // Hide the stop button
                    showToast("Product scanner stopped.", "info");
                    productScannerMessage.classList.add('hidden'); // Hide message
                    lastScannedCode = null; // Reset debounce variable when scanner is explicitly stopped
                }).catch(err => {
                    console.error("Error stopping scanner:", err);
                    showToast("Error stopping scanner.", "error");
                    productScannerMessage.classList.add('hidden'); // Hide message
                    lastScannedCode = null; // Reset debounce variable on stop error
                });
            } else if (html5QrcodeScanner) {
                 // If scanner object exists but isn't scanning, just clear it
                 html5QrcodeScanner.clear();
                 document.getElementById("reader").innerHTML = '';
                 html5QrcodeScanner = null;
                 stopScannerBtn.classList.add('hidden');
                 productScannerMessage.classList.add('hidden'); // Hide message
                 lastScannedCode = null; // Reset debounce variable
            }
        }

        // --- Manager Card Scanner Functions (Simplified for general approval) ---
        // These are just placeholder functions now that the general manager approval uses a direct input.
        function startManagerScanner() {
            showToast("Manager card scanner for this modal is not directly implemented, please use the PIN/Card ID input.", "info");
        }

        function stopManagerScanner() {
            showToast("Manager card scanner operation is not active for this modal.", "info");
        }


        // Expose functions to the global scope for onclick attributes
        window.startScanner = startScanner;
        window.stopScanner = stopScanner;
        window.cashierLogin = cashierLogin; // Expose cashierLogin for the button
        window.approveAction = approveAction; // Expose approveAction for the button


        // --- Event Listeners ---

        // Product Search Input
        productSearchInput.addEventListener('input', (event) => {
            const searchTerm = event.target.value.toLowerCase();
            console.log("Searching for:", searchTerm);
            console.log("Products available for search:", products.length);
            
            if (searchTerm.length > 0) {
                searchResultsDiv.classList.remove('hidden');
                clearSearchBtn.style.display = 'block';
                const filtered = products.filter(product => {
                    const nameMatch = product.name.toLowerCase().includes(searchTerm);
                    const barcodeMatch = product.barcode && product.barcode.toLowerCase().includes(searchTerm);
                    console.log(`Product ${product.name}: nameMatch=${nameMatch}, barcodeMatch=${barcodeMatch}, barcode=${product.barcode}`);
                    return nameMatch || barcodeMatch;
                });
                console.log("Filtered products:", filtered.length);
                renderProducts(filtered);
            } else {
                searchResultsDiv.classList.add('hidden');
                productResultsList.innerHTML = '';
                clearSearchBtn.style.display = 'none';
            }
            resetInactivityTimer();
        });

        // Clear Search Button
        clearSearchBtn.addEventListener('click', () => {
            productSearchInput.value = '';
            searchResultsDiv.classList.add('hidden');
            clearSearchBtn.style.display = 'none';
            productSearchInput.focus();
        });

        // Payment Method Selection
        document.querySelectorAll('.payment-btn').forEach(button => {
            button.addEventListener('click', (event) => {
                resetInactivityTimer();
                // Reset payment confirmation and hide digital status
                paymentConfirmed = false;
                digitalPaymentStatusDiv.classList.add('hidden');
                digitalPaymentMessage.textContent = '';
                digitalPaymentDetails.textContent = '';

                // Remove active styling from all buttons
                document.querySelectorAll('.payment-btn').forEach(btn => {
                    btn.classList.remove('ring-2', 'ring-offset-2', 'ring-blue-500');
                });

                // Add active styling to the clicked button
                event.target.classList.add('ring-2', 'ring-offset-2', 'ring-blue-500');

                selectedPaymentMethod = event.target.id.replace('pay', '').replace('Btn', ''); // e.g., 'Cash', 'Mpesa', 'Card'

                if (selectedPaymentMethod === 'Cash') {
                    cashPaymentSection.classList.remove('hidden');
                    cashReceivedInput.focus();
                } else {
                    cashPaymentSection.classList.add('hidden');
                    balanceAmountSpan.textContent = formatCurrency(0); // Clear balance
                    cashReceivedInput.value = '';

                    // Disable payment buttons during processing
                    payCashBtn.disabled = true;
                    payMpesaBtn.disabled = true;
                    payCardBtn.disabled = true;

                    // Simulate digital payment processing
                    digitalPaymentStatusDiv.classList.remove('hidden');
                    digitalPaymentMessage.textContent = `Connecting to ${selectedPaymentMethod}...`;
                    digitalPaymentDetails.textContent = 'Please wait...';
                    showToast(`Initiating ${selectedPaymentMethod} payment...`, 'info');

                    setTimeout(() => {
                        paymentConfirmed = true;
                        digitalPaymentMessage.textContent = `‚úÖ ${selectedPaymentMethod} Payment Confirmed!`;
                        const grandTotal = parseFloat(grandTotalSpan.textContent.replace('KSh ', ''));
                        cashReceivedInput.value = grandTotal.toFixed(2); // Simulate full payment received for digital methods
                        balanceAmountSpan.textContent = formatCurrency(0); // Balance is 0 for digital payments

                        if (selectedPaymentMethod === 'Mpesa') {
                            const mpesaCode = `MP${Math.random().toString(36).substring(2, 10).toUpperCase()}`;
                            digitalPaymentDetails.textContent = `Transaction Code: ${mpesaCode}\nAmount: ${formatCurrency(grandTotal)}`;
                        } else if (selectedPaymentMethod === 'Card') {
                            digitalPaymentDetails.textContent = `Payment processed via external card machine.\nAmount: ${formatCurrency(grandTotal)}`;
                        }
                        showToast(`${selectedPaymentMethod} payment successful!`, 'success');

                        // Re-enable payment buttons after successful processing
                        payCashBtn.disabled = false;
                        payMpesaBtn.disabled = false;
                        payCardBtn.disabled = false;
                        calculateTotals(); // Re-calculate to enable complete sale button
                    }, 5000); // Changed to 5 seconds for faster testing
                }

                calculateTotals(); // Initial calculation to update complete sale button state
            });
        });

        // Cash Received Input
        cashReceivedInput.addEventListener('input', () => {
            resetInactivityTimer();
            const grandTotal = parseFloat(grandTotalSpan.textContent.replace('KSh ', ''));
            const cashReceived = parseFloat(cashReceivedInput.value) || 0;
            const balance = cashReceived - grandTotal;
            balanceAmountSpan.textContent = formatCurrency(balance);
            calculateTotals(); // Re-calculate to enable/disable complete sale button
        });

        // Complete Sale Button
        completeSaleBtn.addEventListener('click', async () => { 
            resetInactivityTimer();
            if (cart.length === 0) {
                showToast('Cart is empty. Please add items before completing the sale.', 'error');
                return;
            }

            const grandTotal = parseFloat(grandTotalSpan.textContent.replace('KSh ', ''));
            const cashReceived = parseFloat(cashReceivedInput.value) || 0;

            if (selectedPaymentMethod === 'Cash' && cashReceived < grandTotal) {
                showToast('Cash received is less than the Grand Total. Please enter sufficient amount.', 'error');
                return;
            }

            try {
                // Disable complete sale button during processing
                completeSaleBtn.disabled = true;
                completeSaleBtn.innerHTML = `
                    <span class="text-2xl">‚è≥</span>
                    <span>Completing Sale...</span>
                `;

                // Generate receipt content (this will save the sale and generate invoice)
                const receiptContent = await generateReceiptContent();
                
                // Display the receipt modal
                receiptContentBody.innerHTML = receiptContent;
                toggleModal(receiptModal, true);

                // Show success message
                showToast(`Sale Completed!`, 'success');
                
                // Reset POS for next transaction
                resetPOS();
                
            } catch (error) {
                console.error('Error completing sale:', error);
                showToast('Error completing sale. Please try again.', 'error');
                
                // Re-enable complete sale button
                completeSaleBtn.disabled = false;
                completeSaleBtn.innerHTML = `
                    <span class="text-2xl">‚úÖ</span>
                    <span>Complete Sale</span>
                `;
            }
        });

        // Print Receipt Button (main UI)
        printReceiptBtn.addEventListener('click', () => {
            resetInactivityTimer();
            printReceipt();
        });

        // Receipt Modal Close Button
        receiptCloseBtn.addEventListener('click', hideReceipt);

        // Print Button inside Receipt Modal
        printReceiptFromModalBtn.addEventListener('click', () => {
            printReceipt();
        });

        // Download Button inside Receipt Modal
        downloadReceiptBtn.addEventListener('click', () => {
            resetInactivityTimer();
            downloadReceipt();
        });

        // Close modal when clicking outside of it
        window.addEventListener('click', (event) => {
            if (event.target === receiptModal) {
                hideReceipt();
            }
            if (event.target === managerApprovalModal) {
                // Clicking outside the manager approval modal should also close it and cancel the action
                toggleModal(managerApprovalModal, false);
                showToast('Manager approval cancelled.', 'info');
                // No need to execute pendingAction here as it was cancelled
            }
            if (event.target === refundModal) {
                // Clicking outside the refund modal should close it
                toggleModal(refundModal, false);
            }
        });

        // Manager Approval Modal Input Enter Key
        managerCodeInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault(); // Prevent form submission
                approveAction(); // Call the new approval function
            }
        });
        
        // Admin Panel Button
        adminPanelBtn.addEventListener('click', () => {
            resetInactivityTimer();
            window.location.href = 'admin.html'; // This will navigate to admin.html in a real browser
        });

        // Logout Button
        logoutBtn.addEventListener('click', cashierLogout);

        // Cancel Sale Button
        cancelSaleBtn.addEventListener('click', () => {
            resetInactivityTimer();
            if (cart.length === 0) {
                showToast("Cart is empty. Nothing to cancel.", "warning");
                return;
            }
            pendingApprovalAction = cancelCurrentSale;
            pendingApprovalActionDetails = { action: 'Cancel Sale', itemName: 'All Items in Cart' };
            requestManagerApproval();
        });

        // Refund Sale Button
        refundSaleBtn.addEventListener('click', () => {
            resetInactivityTimer();
            openRefundRequest(); // Open refund modal
        });

        // Refund Modal Event Listeners
        searchRefundSaleBtn.addEventListener('click', () => {
            resetInactivityTimer();
            searchRefundSale();
        });

        // Enter key in refund invoice input
        refundInvoiceNoInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                searchRefundSale();
            }
        });

        // Confirm Refund Button
        confirmRefundBtn.addEventListener('click', () => {
            resetInactivityTimer();
            requestRefundApproval();
        });

        // Cancel Refund Button
        cancelRefundBtn.addEventListener('click', () => {
            resetInactivityTimer();
            toggleModal(refundModal, false);
        });


        // Cashier Login Input (Enter key)
        cashierCodeInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault(); // Prevent default form submission behavior
                cashierLogin();
            }
        });

        // --- Inactivity Timer Events ---
        document.addEventListener('mousemove', resetInactivityTimer);
        document.addEventListener('keypress', resetInactivityTimer);
        document.addEventListener('click', resetInactivityTimer);


        // --- Keyboard Shortcuts ---
        document.addEventListener('keydown', (event) => {
            resetInactivityTimer();
            // Only allow POS shortcuts if cashier is logged in
            if (!currentCashier) return;

            // Enter to add item (from search bar)
            if (event.key === 'Enter' && productSearchInput === document.activeElement) {
                const visibleResults = productResultsList.querySelectorAll('.add-to-cart-btn');
                console.log("Enter key pressed, visible results:", visibleResults.length);
                if (visibleResults.length > 0) {
                    console.log("Clicking first add button");
                    visibleResults[0].click(); // Simulate click on the first "Add" button
                    event.preventDefault(); // Prevent default Enter key behavior (e.g., form submission)
                }
            }

            // Ctrl + P to print
            if (event.ctrlKey && event.key === 'p') {
                event.preventDefault(); // Prevent browser's default print dialog
                printReceipt();
            }

            // F2 to focus payment input (cash received)
            if (event.key === 'F2') {
                event.preventDefault(); // Prevent default F2 behavior
                payCashBtn.click(); // Simulate clicking cash button to reveal input
                setTimeout(() => cashReceivedInput.focus(), 100); // Wait for input to be visible
            }
        });


        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize USB scanner detection
            detectUSBScanner();
            
            // Keep input focused for USB barcode scanner entry
            const input = document.getElementById("cashierCode");
            input.focus();
            input.addEventListener("blur", () => setTimeout(() => input.focus(), 100));
            vatRateDisplay.textContent = vatRate * 100;

            // Check for a logged-in cashier in localStorage
            const storedCashier = localStorage.getItem("currentCashier");
            if (storedCashier) {
                currentCashier = JSON.parse(storedCashier);
                cashierNameDisplay.textContent = currentCashier.name;
                cashierLoginDiv.classList.add("hidden"); // Hide login screen if already logged in
                mainPosContent.classList.remove("hidden"); // Show main POS content
                resetInactivityTimer();
                
                // Update scanner status after login
                updateScannerStatus();
                updateScannerModeDisplay();
                
                // Start invoice counter monitoring
                invoiceCounterUnsubscribe = startInvoiceCounterMonitoring();
                
                // Setup real-time listener for products after successful login
                productsSnapshotUnsubscribe = onSnapshot(productsCol, (snapshot) => {
                    products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    console.log("Products updated in real-time:", products);
                    updateCartDisplay(); // Re-render cart if products change (e.g., stock update)
                    calculateTotals();   // Re-calculate totals
                }, (error) => {
                    console.error("Error listening to products collection:", error);
                    showToast("Failed to get real-time product updates. Please check console.", "error");
                });
            } else {
                cashierLoginDiv.classList.remove("hidden"); // Show login screen
                mainPosContent.classList.add("hidden"); // Hide main POS content
                cashierNameDisplay.textContent = "Please Log In";
                cashierCodeInput.focus();
            }
        });
    </script>
</body>
</html>
